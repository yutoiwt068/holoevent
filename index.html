<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Hololive EXPO 2026">
    <link rel="manifest" href="manifest.json">
    <title>Hololive EXPO 2026 イベント管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            padding-bottom: 40px;
            transition: background 0.5s ease;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .next-event-countdown {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .next-event-countdown h3 {
            font-size: 1em;
            opacity: 0.9;
            margin-bottom: 10px;
        }
        
        .next-event-countdown .event-name {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .countdown-display {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .countdown-item {
            text-align: center;
        }
        
        .countdown-number {
            font-size: 3em;
            font-weight: bold;
            line-height: 1;
        }
        
        .countdown-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }
        
        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            font-weight: normal;
        }
        
        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
        }
        
        .filters {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-group label {
            font-weight: bold;
            color: #667eea;
        }
        
        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 1em;
        }
        
        .artist-search-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }
        
        .artist-search-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .artist-search-input {
            width: 100%;
            padding: 15px;
            border: 3px solid #667eea;
            border-radius: 10px;
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        .artist-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .artist-tag {
            background: #f0f0f0;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }
        
        .artist-tag:hover {
            background: #667eea;
            color: white;
            transform: scale(1.05);
        }
        
        .search-results {
            margin-top: 20px;
        }
        
        .result-item {
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #667eea;
        }
        
        .result-item h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .result-item p {
            color: #555;
            margin: 5px 0;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 1.1em;
        }
        
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .add-event-btn {
            padding: 12px 24px;
            border: none;
            background: linear-gradient(135deg, #48c774 0%, #34a85a 100%);
            color: white;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            font-weight: bold;
}
        
        .add-event-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 199, 116, 0.4);
        }

        .notification-btn {
            padding: 12px 24px;
            border: none;
            background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
            color: white;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            font-weight: bold;
        }

        .notification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(254, 202, 87, 0.4);
        }

        .route-btn {
            padding: 12px 24px;
            border: none;
            background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
            color: white;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            font-weight: bold;
        }

        .route-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(72, 198, 239, 0.4);
        }
        .theme-btn {
            padding: 12px 24px;
            border: none;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            font-weight: bold;
        }

        .notification-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #48c774;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            z-index: 10;
        }

        .notification-settings {
            display: grid;
            gap: 20px;
        }

        .notification-item {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .notification-header h4 {
            color: #2c3e50;
            font-size: 1.1em;
        }

        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #48c774;
        }

        input:checked + .slider:before {
            transform: translateX(30px);
        }

        .notification-desc {
            color: #666;
            font-size: 0.9em;
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .notification-options {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .notification-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .notification-options label:hover {
            background: #667eea;
            color: white;
        }

        .notification-options input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }
        

        .route-optimization {
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .route-optimization h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .route-step {
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #48c6ef;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .route-number {
            width: 35px;
            height: 35px;
            background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1em;
            flex-shrink: 0;
        }

        .route-info {
            flex: 1;
        }

        .route-info h5 {
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 1em;
        }

        .route-info p {
            color: #666;
            font-size: 0.9em;
        }

        .route-summary {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #48c6ef 0%, #6f86d6 100%);
            color: white;
            border-radius: 10px;
            text-align: center;
        }

        .route-summary h4 {
            color: white;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .route-summary p {
            font-size: 2em;
            font-weight: bold;
            margin-top: 10px;
        }

        .route-detail {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .route-detail-item {
            text-align: center;
        }

        .route-detail-item .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .route-detail-item .value {
            font-size: 1.3em;
            font-weight: bold;
        }

                .theme-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 20px rgba(240, 147, 251, 0.4);
                }

        .theme-modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        .theme-card {
            height: 120px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .theme-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .theme-card.active::after {
            content: '✓';
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            color: #333;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            line-height: 30px;
            text-align: center;
        }

        .custom-color-section {
            padding: 20px;
            border-top: 2px solid #f0f0f0;
            background: #f8f9fa;
        }

        .custom-color-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .color-picker-group {
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .color-picker-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .color-picker-item label {
            font-size: 0.9em;
            color: #666;
            font-weight: bold;
        }

        .color-picker-item input[type="color"] {
            width: 100px;
            height: 50px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
        }

        .apply-custom-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
        }

        .apply-custom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .view-toggle button {
            padding: 12px 24px;
            border: none;
            background: white;
            color: #667eea;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            font-weight: bold;
        }

        .view-toggle button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .view-toggle button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .calendar-view {
            display: grid;
            gap: 20px;
            min-height: 200px;
        }
        
        .day-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .day-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }
        
        .day-date {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .day-total {
            font-size: 1.2em;
            color: #764ba2;
            font-weight: bold;
        }
        
        .events-grid {
            display: grid;
            gap: 15px;
        }
        
        .event-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .event-card:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .event-card.expo {
            border-left-color: #667eea;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
        }
        
        .event-card.stage {
            border-left-color: #764ba2;
            background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
        }
        
        .event-card.other {
            border-left-color: #48c774;
            background: linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%);
        }
        
        .event-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .event-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .event-detail {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .event-detail .icon {
            font-size: 1.2em;
        }
        
        .event-detail .label {
            font-size: 0.9em;
            color: #555;
        }
        
        .event-price {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
            margin-top: 10px;
        }
        
        .countdown-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .countdown-badge.today {
            background: #e74c3c;
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        .countdown-badge.tomorrow {
            background: #f39c12;
            color: white;
        }
        
        .countdown-badge.soon {
            background: #3498db;
            color: white;
        }
        
        .countdown-badge.upcoming {
            background: #95a5a6;
            color: white;
        }
        
        .countdown-badge.past {
            background: #7f8c8d;
            color: white;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            background: #48c774;
            color: white;
        }
        
        .list-view {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }
        
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background: #f5f7fa;
            cursor: pointer;
        }
        
        .update-notice {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            color: #856404;
        }
        
        .update-notice h4 {
            margin-bottom: 10px;
        }
        
        .update-notice code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        
        .modal-header h2 {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .modal-header .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .modal-header .close:hover {
            transform: scale(1.2);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }
        
        .btn-primary {
            flex: 1;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            flex: 1;
            padding: 15px;
            background: #e0e0e0;
            color: #555;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-delete:hover {
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.4);
        }
        
        .checklist-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .checklist-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checklist-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .checklist-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .checklist-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .checklist-item.completed {
            opacity: 0.6;
        }
        
        .checklist-item.completed .checklist-text {
            text-decoration: line-through;
            color: #999;
        }
        
        .checklist-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .checklist-text {
            flex: 1;
            color: #333;
        }
        
        .checklist-delete {
            padding: 5px 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s;
        }
        
        .checklist-delete:hover {
            background: #c0392b;
        }
        
        .add-checklist-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .add-checklist-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .add-checklist-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .add-checklist-btn {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .add-checklist-btn:hover {
            background: #5568d3;
        }
        
        .checklist-progress {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            text-align: center;
        }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
        
        .checklist-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #667eea;
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .map-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .map-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .map-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .map-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }
        
        .map-btn.google-maps {
            background: #4285f4;
        }
        
        .map-btn.google-maps:hover {
            background: #357ae8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
        }
        
        .map-btn.yahoo-transit {
            background: #ff0033;
        }
        
        .map-btn.yahoo-transit:hover {
            background: #cc0029;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 0, 51, 0.4);
        }
        
        .map-btn.street-view {
            background: #34a853;
        }
        
        .map-btn.street-view:hover {
            background: #2d8e47;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(52, 168, 83, 0.4);
        }
        
        .venue-info {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .venue-info-item {
            display: flex;
            align-items: start;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .venue-info-item:last-child {
            margin-bottom: 0;
        }
        
        .venue-info-icon {
            font-size: 1.2em;
            min-width: 24px;
        }
        
        .venue-info-text {
            flex: 1;
            line-height: 1.5;
        }
        
        .venue-info-text strong {
            color: #667eea;
            display: block;
            margin-bottom: 4px;
        }
        
        .travel-time {
            display: inline-block;
            padding: 8px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .home-location-setting {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        
        .home-location-setting label {
            display: block;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .home-location-setting input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 0.9em;
        }
        
        .home-location-setting input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .home-location-setting small {
            display: block;
            color: #999;
            margin-top: 5px;
            font-size: 0.85em;
        }
        
        .tags-section {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .tags-section h4 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 15px;
        }
        
        .tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .tag.removable {
            padding-right: 8px;
            cursor: pointer;
        }
        
        .tag-remove {
            cursor: pointer;
            font-weight: bold;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        
        .tag-remove:hover {
            opacity: 1;
        }
        
        .tag-input-form {
            display: flex;
            gap: 10px;
        }
        
        .tag-input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
        }
        
        .tag-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .tag-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }
        
        .tag-suggestion {
            padding: 5px 10px;
            background: #e0e0e0;
            border-radius: 15px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tag-suggestion:hover {
            background: #667eea;
            color: white;
        }
        
        .tag-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 15px;
            background: white;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .tag-filter-item {
            padding: 8px 15px;
            background: #f0f0f0;
            border: 2px solid transparent;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tag-filter-item.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .tag-filter-item:hover {
            border-color: #667eea;
        }
        
        .schedule-optimization {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .schedule-optimization h3 {
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .optimization-options {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .optimization-card {
            padding: 15px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .optimization-card h4 {
            color: #2c3e50;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .optimization-card p {
            color: #555;
            font-size: 0.9em;
            line-height: 1.5;
        }
        
        .optimization-badge {
            display: inline-block;
            padding: 4px 10px;
            background: #48c774;
            color: white;
            border-radius: 12px;
            font-size: 0.8em;
            margin-top: 8px;
        }
        
        .optimization-badge.warning {
            background: #f39c12;
        }
        
        .optimization-badge.info {
            background: #3498db;
        }
        
        .conflict-warning {
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .conflict-warning h4 {
            color: #856404;
            margin-bottom: 8px;
        }
        
        .weather-section {
            margin-top: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #56ccf2 0%, #2f80ed 100%);
            border-radius: 10px;
            color: white;
        }

        .weather-section h4 {
            color: white;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .weather-current {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        .weather-icon-large {
            font-size: 5em;
            text-align: center;
        }

        .weather-main-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .weather-temp-large {
            font-size: 3em;
            font-weight: bold;
        }

        .weather-description-large {
            font-size: 1.3em;
            opacity: 0.9;
        }

        .weather-feels-like {
            font-size: 0.95em;
            opacity: 0.8;
        }

        .hourly-weather {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .hour-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            transition: all 0.3s;
        }

        .hour-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }

        .hour-item .time {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        .hour-item .icon {
            font-size: 2.5em;
            margin: 8px 0;
        }

        .hour-item .temp {
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 5px;
        }

        .hour-item .rain {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .weather-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .weather-detail-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .weather-detail-item .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .weather-detail-item .value {
            font-size: 1.4em;
            font-weight: bold;
        }

        .clothing-advice {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        .clothing-advice h5 {
            color: white;
            margin-bottom: 12px;
            font-size: 1.05em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .clothing-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .clothing-item {
            background: rgba(255, 255, 255, 0.3);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .clothing-item:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .weather-loading {
            text-align: center;
            padding: 30px;
            color: white;
            opacity: 0.8;
            font-size: 1.1em;
        }

        .weather-error {
            padding: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            text-align: center;
            color: white;
        }
        
        .event-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background: #667eea;
            color: white;
        }
        
        .btn-edit:hover {
            background: #5568d3;
        }
        
        .custom-event-badge {
            display: inline-block;
            padding: 5px 10px;
            background: #48c774;
            color: white;
            border-radius: 5px;
            font-size: 0.8em;
            margin-left: 10px;
        }
        
        .modal-info-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .modal-info-item {
            display: flex;
            align-items: start;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .modal-info-item .icon {
            font-size: 1.5em;
            min-width: 30px;
        }
        
        .modal-info-item .content h4 {
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .modal-info-item .content p {
            color: #555;
            line-height: 1.6;
        }
        
        .artist-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .artist-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
        }
        
        .official-link {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            margin-top: 20px;
        }
        
        .official-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
                padding-bottom: 60px;
                overflow-x: hidden;
            }
            
            .container {
                width: 100%;
                overflow: visible;
            }
            
            h1 {
                font-size: 1.3em;
                word-break: break-word;
                line-height: 1.3;
            }
            
            header {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-card {
                padding: 12px;
            }
            
            .summary-card h3 {
                font-size: 0.8em;
            }
            
            .summary-card .value {
                font-size: 1.5em;
            }
            
            .artist-search-section {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .artist-search-section h2 {
                font-size: 1.1em;
            }
            
            .artist-search-input {
                padding: 10px;
                font-size: 0.95em;
            }
            
            .update-notice {
                padding: 10px;
                font-size: 0.85em;
                margin-bottom: 15px;
            }
            
            .update-notice h4 {
                font-size: 1em;
            }
            
            .filters {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .filter-group label {
                font-size: 0.9em;
            }
            
            .filter-group input {
                width: 100%;
                padding: 10px;
                font-size: 0.95em;
            }
            
            .view-toggle {
                gap: 8px;
                margin-bottom: 15px;
            }
            
            .add-event-btn {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }
            
            .day-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .event-details {
                grid-template-columns: 1fr;
            }
            
            .event-title {
                font-size: 1em;
                line-height: 1.3;
            }
            
            .event-price {
                font-size: 1.2em;
            }
            
            .event-detail .label {
                font-size: 0.85em;
            }
            
            .day-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .day-date {
                font-size: 1.1em;
            }
            
            .day-total {
                font-size: 0.95em;
            }
            
            .list-view {
                padding: 15px;
                overflow-x: auto;
            }
            
            table {
                font-size: 0.75em;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            th, td {
                padding: 8px 6px;
            }
            
            .modal-content {
                width: 95%;
                margin: 3% auto;
                max-height: 94vh;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-header h2 {
                font-size: 1.2em;
                padding-right: 35px;
                word-break: break-word;
                line-height: 1.3;
            }
            
            .modal-header .close {
                font-size: 1.8em;
                right: 10px;
                top: 10px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-info-item {
                padding: 12px;
            }
            
            .modal-info-item .icon {
                font-size: 1.2em;
            }
            
            .modal-info-item .content h4 {
                font-size: 0.95em;
            }
            
            .modal-info-item .content p {
                font-size: 0.85em;
            }
            
            .artist-badge {
                font-size: 0.8em;
                padding: 5px 10px;
            }
            
            .artist-list {
                gap: 6px;
            }
            
            .official-link {
                padding: 12px 20px;
                font-size: 0.9em;
                display: block;
                text-align: center;
            }
            
            .result-item {
                padding: 12px;
                margin-bottom: 10px;
            }
            
            .result-item h3 {
                font-size: 1em;
                line-height: 1.3;
            }
            
            .result-item p {
                font-size: 0.85em;
                line-height: 1.4;
            }
            
            .status-badge {
                font-size: 0.8em;
                padding: 4px 12px;
            }
            .notification-btn,
            .route-btn,
            .theme-btn {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }
            
            .hourly-weather {
                grid-template-columns: repeat(4, 1fr);
                gap: 8px;
            }
            
            .hour-item {
                padding: 10px 5px;
            }
            
            .hour-item .icon {
                font-size: 2em;
            }
            
            .weather-details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .weather-current {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .weather-temp-large {
                font-size: 2.5em;
            }
        }
        
        .theme-btn {
        width: 100%;
        margin-left: 0;
        margin-top: 10px;
    }
    
    .theme-modal-content {
        width: 95%;
        margin: 5% auto;
    }
    
    .theme-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        padding: 15px;
    }
    
    .theme-card {
        height: 100px;
        font-size: 0.85em;
    }
    
    .custom-color-section {
        padding: 15px;
    }
    
    .color-picker-group {
        flex-direction: column;
        align-items: stretch;
    }
    
    .color-picker-item {
        width: 100%;
    }
    
    .color-picker-item input[type="color"] {
        width: 100%;
    }
    
    .apply-custom-btn {
        width: 100%;
        margin-top: 10px;
    }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>🎪 Hololive EXPO 2026 イベント管理</h1>
            <div id="nextEventCountdown" class="next-event-countdown" style="display: none;"></div>
            <div class="summary" id="summary"></div>
        </header>
        
        <!-- アーティスト検索セクション -->
        <div class="artist-search-section">
            <h2>🎤 アーティスト検索</h2>
            <input type="text" 
                   id="artistSearchInput" 
                   class="artist-search-input" 
                   placeholder="アーティスト名を入力... (例: 風真いろは、Kazama Iroha)">
            <div id="searchResults" class="search-results"></div>
        </div>
        
        <div class="update-notice">
            <h4>📝 使い方</h4>
            <p>• イベントカードをクリックすると詳細情報・出演者が表示されます<br>
            • アーティスト検索で出演ステージを確認できます<br>
            • 対応エリア: 幕張・有明・渋谷・新宿・池袋・秋葉原・横浜・みなとみらい（会場名は正式名称で入力）<br>
            • 対応駅: 上記エリア（最後に「駅」をつけること）</p>
        </div>
        
        <div class="filters">
            <div class="filter-group">
                <label>🔍 イベント検索:</label>
                <input type="text" id="searchInput" placeholder="イベント名で検索...">
                
                <label>📅 日付:</label>
                <input type="date" id="dateFilter">
            </div>
        </div>
        
        <div class="view-toggle">
            <button class="active" onclick="switchView('calendar')">📅 カレンダービュー</button>
            <button onclick="switchView('list')">📋 リストビュー</button>
            <button class="notification-btn" onclick="openNotificationModal()">🔔 通知設定</button>
            <button class="route-btn" onclick="openRouteModal()">🗺️ ルート最適化</button>
            <button class="theme-btn" onclick="openThemeModal()">🎨 テーマ変更</button>
            <button class="add-event-btn" onclick="openAddEventModal()">➕ 予定を追加</button>
        </div>
        
        <!-- タグフィルター -->
        <div id="tagFilter" class="tag-filter" style="display: none;"></div>
        
        <!-- スケジュール最適化 -->
        <div id="scheduleOptimization" class="schedule-optimization" style="display: none;"></div>
        
        <div id="calendarView" class="calendar-view">
            <div style="text-align: center; padding: 50px; color: white;">
                読み込み中...
            </div>
        </div>
        <div id="listView" class="list-view" style="display: none;">
            <div style="text-align: center; padding: 50px; color: #999;">
                読み込み中...
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeModal()">&times;</span>
                <h2 id="modalTitle"></h2>
                <p id="modalDate"></p>
            </div>
            <div class="modal-body" id="modalBody"></div>
        </div>
    </div>

    <!-- 予定追加モーダル -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeAddEventModal()">&times;</span>
                <h2 id="addEventModalTitle">予定を追加</h2>
            </div>
            <div class="modal-body">
                <form id="addEventForm" onsubmit="saveCustomEvent(event)">
                    <div class="form-group">
                        <label for="eventName">イベント名 *</label>
                        <input type="text" id="eventName" required placeholder="例: 友達と遊ぶ">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventDate">日付 *</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="eventTime">時間</label>
                        <input type="text" id="eventTime" placeholder="例: 14:00~16:00">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventVenue">場所</label>
                        <input type="text" id="eventVenue" placeholder="例: 渋谷駅、有明、横浜">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventPrice">料金（円）</label>
                        <input type="number" id="eventPrice" placeholder="0" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label for="eventDescription">メモ</label>
                        <textarea id="eventDescription" placeholder="詳細情報やメモを入力..."></textarea>
                    </div>
                    
                    <input type="hidden" id="editEventId">
                    
                    <div class="form-actions">
                        <button type="button" class="btn-secondary" onclick="closeAddEventModal()">キャンセル</button>
                        <button type="submit" class="btn-primary" id="saveEventBtn">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 通知設定モーダル -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeNotificationModal()">&times;</span>
                <h2>🔔 通知設定</h2>
                <p style="font-size: 0.9em; opacity: 0.9; margin-top: 10px;">イベントごとに通知をカスタマイズできます</p>
            </div>
            <div class="modal-body">
                <div class="notification-settings" id="notificationSettings"></div>
            </div>
        </div>
    </div>

    <!-- ルート最適化モーダル -->
    <div id="routeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeRouteModal()">&times;</span>
                <h2>🗺️ ルート最適化</h2>
                <p style="font-size: 0.9em; opacity: 0.9; margin-top: 10px;">効率的な移動ルートを提案します</p>
            </div>
            <div class="modal-body" id="routeOptimizationContent"></div>
        </div>
    </div>

    <!-- テーマ変更モーダル -->
    <div id="themeModal" class="modal">
        <div class="modal-content theme-modal-content">
            <div class="modal-header">
                <span class="close" onclick="closeThemeModal()">&times;</span>
                <h2>🎨 背景テーマを選択</h2>
                <p style="font-size: 0.9em; opacity: 0.9; margin-top: 10px;">お好みのテーマを選んでください</p>
            </div>
            <div class="theme-grid" id="themeGrid"></div>
            <div class="custom-color-section">
                <h4>🎨 カスタムカラー</h4>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
                    自分だけのオリジナルグラデーションを作成できます
                </p>
                <div class="color-picker-group">
                    <div class="color-picker-item">
                        <label>開始色</label>
                        <input type="color" id="customColor1" value="#667eea">
                    </div>
                    <div class="color-picker-item">
                        <label>終了色</label>
                        <input type="color" id="customColor2" value="#764ba2">
                    </div>
                    <button class="apply-custom-btn" onclick="applyCustomTheme()">✨ 適用する</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 通知設定
        let notificationSettings = {};
        // テーマデータ
        const themes = [
            { name: 'デフォルト（紫）', color1: '#667eea', color2: '#764ba2', emoji: '💜' },
            { name: 'ピンク', color1: '#f093fb', color2: '#f5576c', emoji: '💗' },
            { name: '青空', color1: '#4facfe', color2: '#00f2fe', emoji: '🌊' },
            { name: '夕焼け', color1: '#fa709a', color2: '#fee140', emoji: '🌅' },
            { name: '森', color1: '#56ab2f', color2: '#a8e063', emoji: '🌲' },
            { name: 'オーロラ', color1: '#a8edea', color2: '#fed6e3', emoji: '✨' },
            { name: '夜空', color1: '#2c3e50', color2: '#3498db', emoji: '🌙' },
            { name: 'オレンジ', color1: '#ff6b6b', color2: '#feca57', emoji: '🍊' },
            { name: 'ミント', color1: '#a8e6cf', color2: '#dcedc1', emoji: '🍃' },
            { name: 'ラベンダー', color1: '#c471f5', color2: '#fa71cd', emoji: '🌸' },
            { name: 'ゴールド', color1: '#f7971e', color2: '#ffd200', emoji: '👑' },
            { name: 'ダークモード', color1: '#232526', color2: '#414345', emoji: '🌑' }
        ];

        let currentTheme = null;
        // アーティストデータ
        const artistsData = {
            "STAGE1": [
                { ja: "白上フブキ", en: "Shirakami Fubuki" },
                { ja: "百鬼あやめ", en: "Nakiri Ayame" },
                { ja: "癒月ちょこ", en: "Yuzuki Choco" },
                { ja: "猫又おかゆ", en: "Nekomata Okayu" },
                { ja: "兎田ぺこら", en: "Usada Pekora" },
                { ja: "不知火フレア", en: "Shiranui Flare" },
                { ja: "角巻わため", en: "Tsunomaki Watame" },
                { ja: "雪花ラミィ", en: "Yukihana Lamy" },
                { ja: "尾丸ポルカ", en: "Omaru Polka" },
                { ja: "鷹嶺ルイ", en: "Takane Lui" },
                { ja: "博衣こより", en: "Hakui Koyori" },
                { ja: "ベスティア・ゼータ", en: "Vestia Zeta" },
                { ja: "こぼ・かなえる", en: "Kobo Kanaeru" },
                { ja: "一伊那尓栖", en: "Ninomae Ina'nis" },
                { ja: "フワワ・アビスガード", en: "Fuwawa Abyssgard" },
                { ja: "モココ・アビスガード", en: "Mococo Abyssgard" }
            ],
            "STAGE2": [
                { ja: "ときのそら", en: "Tokino Sora" },
                { ja: "さくらみこ", en: "Sakura Miko" },
                { ja: "大空スバル", en: "Oozora Subaru" },
                { ja: "大神ミオ", en: "Ookami Mio" },
                { ja: "桃鈴ねね", en: "Momosuzu Nene" },
                { ja: "獅白ぼたん", en: "Shishiro Botan" },
                { ja: "ラプラス・ダークネス", en: "La+ Darknesss" },
                { ja: "アイラニ・イオフィフティーン", en: "Airani Iofifteen" },
                { ja: "クレイジー・オリー", en: "Kureiji Ollie" },
                { ja: "小鳥遊キアラ", en: "Takanashi Kiara" },
                { ja: "エリザベス・ローズ・ブラッドフレイム", en: "Elizabeth Rose Bloodflame" },
                { ja: "ジジ・ムリン", en: "Gigi Murin" },
                { ja: "セシリア・イマーグリーン", en: "Cecilia Immergreen" },
                { ja: "ラオーラ・パンテーラ", en: "Raora Panthera" }
            ],
            "STAGE3": [
                { ja: "AZKi", en: "AZKi" },
                { ja: "夏色まつり", en: "Natsuiro Matsuri" },
                { ja: "白銀ノエル", en: "Shirogane Noel" },
                { ja: "姫森ルーナ", en: "Himemori Luna" },
                { ja: "風真いろは", en: "Kazama Iroha" },
                { ja: "アユンダ・リス", en: "Ayunda Risu" },
                { ja: "パヴォリア・レイネ", en: "Pavolia Reine" },
                { ja: "IRyS", en: "IRyS" },
                { ja: "ハコス・ベールズ", en: "Hakos Baelz" },
                { ja: "シオリ・ノヴェラ", en: "Shiori Novella" },
                { ja: "響咲リオナ", en: "Isaki Riona" },
                { ja: "虎金妃笑虎", en: "Koganei Niko" },
                { ja: "水宮枢", en: "Mizumiya Su" },
                { ja: "輪堂千速", en: "Rindo Chihaya" },
                { ja: "綺々羅々ヴィヴィ", en: "Kikirara Vivi" }
            ],
            "STAGE4": [
                { ja: "ロボ子さん", en: "Robocosan" },
                { ja: "星街すいせい", en: "Hoshimachi Suisei" },
                { ja: "アキ・ローゼンタール", en: "Aki Rosenthal" },
                { ja: "宝鐘マリン", en: "Houshou Marine" },
                { ja: "常闇トワ", en: "Tokoyami Towa" },
                { ja: "ムーナ・ホシノヴァ", en: "Moona Hoshinova" },
                { ja: "アーニャ・メルフィッサ", en: "Anya Melfissa" },
                { ja: "カエラ・コヴァルスキア", en: "Kaela Kovalskia" },
                { ja: "森カリオペ", en: "Mori Calliope" },
                { ja: "オーロ・クロニー", en: "Ouro Kronii" },
                { ja: "古石ビジュー", en: "Koseki Bijou" },
                { ja: "ネリッサ・レイヴンクロフト", en: "Nerissa Ravencroft" },
                { ja: "音乃瀬奏", en: "Otonose Kanade" },
                { ja: "一条莉々華", en: "Ichijou Ririka" },
                { ja: "儒烏風亭らでん", en: "Juufuutei Raden" },
                { ja: "轟はじめ", en: "Todoroki Hajime" }
            ]
        };

        let eventsData = [
            {
                name: "hololive SUPER EXPO 2026 DAY1",
                status: "開始前",
                time: "9時~18時",
                venue: "国際展示場4-8&イベントホール",
                date: "2026-03-06",
                price: 6600,
                url: "hololivesuperEXPO公式",
                description: "hololive time-warp をテーマに、時空を超えてhololiveの広大な世界を体験できる3日間のイベント初日。",
                officialUrl: "https://hololivesuperexpo.hololivepro.com/2026/expo/"
            },
            {
                name: "hololive STAGE1",
                status: "開始前",
                time: "17:00(場)18:30(演)",
                venue: "国際展示場1-3",
                date: "2026-03-06",
                price: 11000,
                url: "Hololive expo in 2026 （共）",
                description: "hololive 7th fes. Ridin' on Dreams の初日公演。。",
                officialUrl: "https://hololivesuperexpo.hololivepro.com/2026/fes/cast/?tab=stage1",
                artists: artistsData.STAGE1
            },
            {
                name: "hololive SUPER EXPO 2026 DAY2",
                status: "開始前",
                time: "9時~18時",
                venue: "国際展示場4-8&イベントホール",
                date: "2026-03-07",
                price: 6600,
                url: "当日行程表（改） （個）",
                description: "EXPO 2日目。PARALLEL、BLAST、FUTURE の3つのメインエリアでhololiveの世界を多角的に楽しめる。",
                officialUrl: "https://hololivesuperexpo.hololivepro.com/2026/expo/"
            },
            {
                name: "hololive STAGE2",
                status: "開始前",
                time: "11:30(場)13:00(演)",
                venue: "国際展示場1-3",
                date: "2026-03-07",
                price: 11000,
                url: "Hololive EXPO Infor （共）",
                description: "7th fes. 2日目の昼公演。",
                officialUrl: "https://hololivesuperexpo.hololivepro.com/2026/fes/cast/?tab=stage2",
                artists: artistsData.STAGE2
            },
            {
                name: "hololive STAGE3",
                status: "開始前",
                time: "17:00(場)18:30(演)",
                venue: "国際展示場1-3",
                date: "2026-03-07",
                price: 11000,
                url: "Hololive expo 2026 予算 （共）",
                description: "7th fes. 2日目の夕方公演。",
                officialUrl: "https://hololivesuperexpo.hololivepro.com/2026/fes/cast/?tab=stage3",
                artists: artistsData.STAGE3
            },
            {
                name: "hololive SUPER EXPO 2026 DAY3",
                status: "開始前",
                time: "9時~18時",
                venue: "国際展示場4-8&イベントホール",
                date: "2026-03-08",
                price: 6600,
                url: "Hololive 7th Fes EXPO - 2026 （共）",
                description: "EXPO最終日。3日間の集大成として、特別な展示やイベントが用意されている。",
                officialUrl: "https://hololivesuperexpo.hololivepro.com/2026/expo/"
            },
            {
                name: "hololive STAGE4",
                status: "開始前",
                time: "11:30(場)13:00(演)",
                venue: "国際展示場1-3",
                date: "2026-03-08",
                price: 11000,
                url: "当日予定案 （共）",
                description: "7th fes. 最終日公演。",
                officialUrl: "https://hololivesuperexpo.hololivepro.com/2026/fes/cast/?tab=stage4",
                artists: artistsData.STAGE4
            },
            {
                name: "交通費（行き）",
                status: "---------",
                time: "---------",
                venue: "---------",
                date: "2026-03-05",
                price: 659,
                url: "hololive 7th EXPO and Fes. memo （共）",
                description: "イベント会場への往路交通費"
            },
            {
                name: "交通費（帰り）",
                status: "---------",
                time: "---------",
                venue: "---------",
                date: "2026-03-09",
                price: 659,
                url: "合計金額+宿泊費",
                description: "イベント会場からの復路交通費"
            },
            {
                name: "グッズ",
                status: "---------",
                time: "---------",
                venue: "---------",
                date: "2026-03-06",
                price: 10000,
                url: "",
                description: "イベントグッズ購入予算"
            }
        ];
        
        let currentView = 'calendar';
        let customEvents = [];
        let eventChecklists = {};
        let homeLocation = '';
        let eventTags = {};
        let activeTagFilter = null;
        
        const tagSuggestions = [
            '🎤 推し出演',
            '🎫 チケット確保済み',
            '⭐ 優先度高',
            '🛍️ 物販のみ',
            '📷 撮影OK',
            '👥 友達と参加',
            '🏨 宿泊必要',
            '🎁 グッズ購入予定',
            '🎵 初参戦',
            '💖 絶対行く'
        ];
        
        // 会場情報データベース（拡張版）
        const venueDatabase = {
            // 幕張
            '国際展示場4-8&イベントホール': {
                name: '幕張メッセ 国際展示場4-8ホール & イベントホール',
                address: '〒261-8550 千葉県千葉市美浜区中瀬2-1',
                station: 'JR京葉線 海浜幕張駅',
                walkTime: '徒歩約11分',
                lat: 35.64824,
                lng: 140.03443,
                tips: '国際展示場エリアは広いため、事前に会場図を確認することをおすすめします。'
            },
            '国際展示場1-3': {
                name: '幕張メッセ 国際展示場1-3ホール',
                address: '〒261-8550 千葉県千葉市美浜区中瀬2-1',
                station: 'JR京葉線 海浜幕張駅',
                walkTime: '徒歩約11分',
                lat: 35.64791,
                lng: 140.03285,
                tips: 'ライブ会場は音響設備が優れています。開演30分前には到着することをおすすめします。'
            },
            '幕張': {
                name: '幕張エリア',
                address: '千葉県千葉市美浜区',
                station: 'JR京葉線 海浜幕張駅',
                walkTime: '駅周辺',
                lat: 35.6489,
                lng: 140.0339,
                tips: '幕張新都心エリアは広いので、時間に余裕を持って移動しましょう。'
            },
            '幕張メッセ': {
                name: '幕張エリア',
                address: '千葉県千葉市美浜区',
                station: 'JR京葉線 海浜幕張駅',
                walkTime: '徒歩約11分',
                lat: 35.64803,
                lng: 140.03542,
                tips: '千葉県千葉市美浜区にある日本最大級のコンベンション施設。'
            },
            '海浜幕張駅': {
                name: '海浜幕張駅',
                address: '千葉県千葉市美浜区',
                station: 'JR京葉線 海浜幕張駅',
                walkTime: '駅周辺',
                lat: 34.64852,
                lng: 140.04198,
                tips: '幕張メッセ・ZOZOマリンスタジアムは南口、飲食店やゲームセンターは北口に集中しています。'
            },
            
            // 有明（東京ビッグサイト・有明アリーナなど）
            '有明': {
                name: '有明エリア（東京ビッグサイト・有明アリーナ周辺）',
                address: '〒135-0063 東京都江東区有明',
                station: 'りんかい線 国際展示場駅 / ゆりかもめ 有明駅',
                walkTime: '駅から徒歩約3-7分',
                lat: 35.6298,
                lng: 139.7946,
                tips: '有明エリアはビッグサイト、有明アリーナ、東京ガーデンシアターなど大型施設が集中しています。施設間の移動時間も考慮しましょう。'
            },
            '東京ビッグサイト': {
                name: '東京ビッグサイト（東京国際展示場）',
                address: '〒135-0063 東京都江東区有明3-11-1',
                station: 'りんかい線 国際展示場駅',
                walkTime: '徒歩約7分',
                lat: 35.6298,
                lng: 139.7946,
                tips: '東京最大級の展示場。各ホールへの移動に時間がかかることがあります。'
            },
            '有明アリーナ': {
                name: '有明アリーナ',
                address: '〒135-0063 東京都江東区有明1-11-1',
                station: 'ゆりかもめ 有明テニスの森駅',
                walkTime: '徒歩約8分',
                lat: 35.6334,
                lng: 139.7928,
                tips: '大型アリーナ。開演時間に合わせた混雑を予想して早めの到着を。'
            },
            '東京ガーデンシアター': {
                name: '東京ガーデンシアター',
                address: '〒135-0063 東京都江東区有明1-3-25',
                station: 'ゆりかもめ 有明駅',
                walkTime: '徒歩約4分',
                lat: 35.6329,
                lng: 139.7915,
                tips: '有明ガーデン内の劇場型ホール。座席が近く臨場感のある会場です。'
            },
            
            // 渋谷
            '渋谷': {
                name: '渋谷エリア',
                address: '東京都渋谷区',
                station: 'JR・東急・京王・メトロ 渋谷駅',
                walkTime: '駅周辺',
                lat: 35.6595,
                lng: 139.7004,
                tips: '渋谷駅は複雑です。出口を事前に確認しておくとスムーズです。'
            },
            '渋谷駅': {
                name: '渋谷駅周辺',
                address: '東京都渋谷区道玄坂',
                station: '渋谷駅',
                walkTime: '駅直結',
                lat: 35.6595,
                lng: 139.7004,
                tips: '駅構内は広く、迷いやすいので時間に余裕を持ちましょう。'
            },
            
            // 新宿
            '新宿': {
                name: '新宿エリア',
                address: '東京都新宿区',
                station: 'JR・小田急・京王・メトロ 新宿駅',
                walkTime: '駅周辺',
                lat: 35.6896,
                lng: 139.7006,
                tips: '新宿駅は世界一の利用者数。出口番号を確認して移動しましょう。'
            },
            '新宿駅': {
                name: '新宿駅周辺',
                address: '東京都新宿区西新宿',
                station: '新宿駅',
                walkTime: '駅直結',
                lat: 35.6896,
                lng: 139.7006,
                tips: '東口・西口・南口で雰囲気が全く違います。目的地の最寄り口を確認を。'
            },
            
            // 池袋
            '池袋': {
                name: '池袋エリア',
                address: '東京都豊島区',
                station: 'JR・東武・西武・メトロ 池袋駅',
                walkTime: '駅周辺',
                lat: 35.7295,
                lng: 139.7109,
                tips: '東口・西口で雰囲気が異なります。サンシャインシティへは東口が便利。'
            },
            '池袋駅': {
                name: '池袋駅周辺',
                address: '東京都豊島区南池袋',
                station: '池袋駅',
                walkTime: '駅直結',
                lat: 35.7295,
                lng: 139.7109,
                tips: '東口はアニメイトなどのサブカル施設が充実しています。'
            },
            
            // 秋葉原
            '秋葉原': {
                name: '秋葉原エリア',
                address: '東京都千代田区外神田',
                station: 'JR・つくばエクスプレス・メトロ 秋葉原駅',
                walkTime: '駅周辺',
                lat: 35.6984,
                lng: 139.7731,
                tips: 'グッズ販売店が多く存在し、土日は特に混雑します。'
            },
            '秋葉原駅': {
                name: '秋葉原駅周辺',
                address: '東京都千代田区外神田1丁目',
                station: '秋葉原駅',
                walkTime: '駅直結',
                lat: 35.6984,
                lng: 139.7731,
                tips: '電気街口が便利。週末は歩行者天国が実施されることも。'
            },
            
            // 横浜
            '横浜': {
                name: '横浜エリア',
                address: '神奈川県横浜市',
                station: 'JR・京急・相鉄・市営地下鉄 横浜駅',
                walkTime: '駅周辺',
                lat: 35.4657,
                lng: 139.6220,
                tips: '横浜駅は広く、みなとみらいやベイエリアへの移動は徒歩またはバスで。'
            },
            '横浜駅': {
                name: '横浜駅周辺',
                address: '神奈川県横浜市西区',
                station: '横浜駅',
                walkTime: '駅直結',
                lat: 35.4657,
                lng: 139.6220,
                tips: '東口・西口で大きく雰囲気が変わります。目的地を確認しましょう。'
            },
            'みなとみらい': {
                name: 'みなとみらいエリア',
                address: '神奈川県横浜市西区みなとみらい',
                station: 'みなとみらい線 みなとみらい駅',
                walkTime: '駅周辺',
                lat: 35.4564,
                lng: 139.6316,
                tips: 'パシフィコ横浜やぴあアリーナMMなど大型施設が集中しています。'
            },
            'パシフィコ横浜': {
                name: 'パシフィコ横浜（横浜国際平和会議場）',
                address: '〒220-0012 神奈川県横浜市西区みなとみらい1-1-1',
                station: 'みなとみらい線 みなとみらい駅',
                walkTime: '徒歩約5分',
                lat: 35.4564,
                lng: 139.6316,
                tips: '海沿いの大型コンベンションセンター。展示ホール・会議センターなど複数施設があります。'
            },
            'Kアリーナ横浜': {
                name: 'Kアリーナ横浜',
                address: '〒220-0012 神奈川県横浜市西区みなとみらい6-2-14',
                station: 'みなとみらい線 新高島駅',
                walkTime: '徒歩約3分',
                lat: 35.4622,
                lng: 139.6254,
                tips: '2023年開業の最新大型アリーナ。最大2万人収容の国内最大級施設です。'
            },
            'ぴあアリーナMM': {
                name: 'ぴあアリーナMM',
                address: '〒220-0012 神奈川県横浜市西区みなとみらい3-2-9',
                station: 'みなとみらい線 みなとみらい駅',
                walkTime: '徒歩約2分',
                lat: 35.4592,
                lng: 139.6281,
                tips: '1万人収容の音楽特化型アリーナ。音響にこだわった設計が特徴です。'
            }
        };
        
        function loadHomeLocation() {
            const saved = localStorage.getItem('homeLocation');
            if (saved) {
                homeLocation = saved;
            }
        }

        function loadNotificationSettings() {
            const saved = localStorage.getItem('notificationSettings');
            if (saved) {
                notificationSettings = JSON.parse(saved);
            } else {
                // デフォルト設定（全イベントに適用）
                const allEvents = getAllEvents();
                allEvents.forEach(event => {
                    const eventId = event.id || event.name;
                    notificationSettings[eventId] = {
                        enabled: true,
                        threeDaysBefore: true,
                        oneDayBefore: true,
                        morning: true
                    };
                });
            }
        }

        function saveNotificationSettings() {
            localStorage.setItem('notificationSettings', JSON.stringify(notificationSettings));
        }

        function getNotificationSetting(eventId) {
            if (!notificationSettings[eventId]) {
                notificationSettings[eventId] = {
                    enabled: true,
                    threeDaysBefore: true,
                    oneDayBefore: true,
                    morning: true
                };
            }
            return notificationSettings[eventId];
        }

        function loadTheme() {
            const saved = localStorage.getItem('appTheme');
            if (saved) {
                currentTheme = JSON.parse(saved);
                applyTheme(currentTheme.color1, currentTheme.color2);
            }
        }

        function saveTheme(color1, color2) {
            currentTheme = { color1, color2 };
            localStorage.setItem('appTheme', JSON.stringify(currentTheme));
        }

        function applyTheme(color1, color2) {
            document.body.style.background = `linear-gradient(135deg, ${color1} 0%, ${color2} 100%)`;
        }
        
        function saveHomeLocation(location) {
            homeLocation = location;
            localStorage.setItem('homeLocation', location);
        }
        
        function loadTags() {
            const saved = localStorage.getItem('eventTags');
            if (saved) {
                eventTags = JSON.parse(saved);
            }
        }
        
        function saveTags() {
            localStorage.setItem('eventTags', JSON.stringify(eventTags));
        }
        
        function getTags(eventId) {
            if (!eventTags[eventId]) {
                eventTags[eventId] = [];
            }
            return eventTags[eventId];
        }
        
        function getAllTags() {
            const allTags = new Set();
            Object.values(eventTags).forEach(tags => {
                tags.forEach(tag => allTags.add(tag));
            });
            return Array.from(allTags);
        }
        
        function loadCustomEvents() {
            const saved = localStorage.getItem('customEvents');
            if (saved) {
                customEvents = JSON.parse(saved);
            }
        }
        
        function loadChecklists() {
            const saved = localStorage.getItem('eventChecklists');
            if (saved) {
                eventChecklists = JSON.parse(saved);
            }
        }
        
        function saveChecklists() {
            localStorage.setItem('eventChecklists', JSON.stringify(eventChecklists));
        }
        
        function getChecklist(eventId) {
            if (!eventChecklists[eventId]) {
                eventChecklists[eventId] = [];
            }
            return eventChecklists[eventId];
        }
        
        function saveCustomEventsToStorage() {
            localStorage.setItem('customEvents', JSON.stringify(customEvents));
        }
        
        function getAllEvents() {
            return [...eventsData, ...customEvents];
        }

        // 通知権限をリクエスト
function requestNotificationPermission() {
    if ('Notification' in window) {
        if (Notification.permission === 'default') {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    console.log('✅ 通知権限が許可されました');
                    showWelcomeNotification();
                } else {
                    console.log('❌ 通知権限が拒否されました');
                }
            });
        } else if (Notification.permission === 'granted') {
            console.log('✅ 通知権限は既に許可されています');
        }
    } else {
        console.log('⚠️ このブラウザは通知をサポートしていません');
    }
}

// ウェルカム通知を表示
function showWelcomeNotification() {
    if (Notification.permission === 'granted') {
        const notification = new Notification('🎪 Hololive EXPO 2026', {
            body: '通知機能が有効になりました！イベント前にリマインドします。',
            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">🎪</text></svg>',
            tag: 'welcome',
            requireInteraction: false
        });
        
        notification.onclick = function() {
            window.focus();
            notification.close();
        };
    }
}

// 通知をチェックして送信
function checkAndSendNotifications() {
    if (Notification.permission !== 'granted') {
        return;
    }
    
    const now = new Date();
    const allEvents = getAllEvents();
    
    allEvents.forEach(event => {
        const eventId = event.id || event.name;
        const setting = getNotificationSetting(eventId);
        
        // 通知が無効ならスキップ
        if (!setting.enabled) {
            return;
        }
        
        const eventDate = new Date(event.date);
        
        // 通知履歴をチェック（同じ通知を何度も送らないように）
        const notificationHistory = getNotificationHistory();
        
        // 3日前の通知（朝9時）
        if (setting.threeDaysBefore) {
            const threeDaysBefore = new Date(eventDate);
            threeDaysBefore.setDate(threeDaysBefore.getDate() - 3);
            threeDaysBefore.setHours(9, 0, 0, 0);
            
            if (shouldSendNotification(now, threeDaysBefore, eventId, '3days', notificationHistory)) {
                sendEventNotification(event, '📅 3日前のリマインド', `${event.name}まであと3日です！準備を始めましょう。`);
                saveNotificationHistory(eventId, '3days');
            }
        }
        
        // 1日前の通知（夜8時）
        if (setting.oneDayBefore) {
            const oneDayBefore = new Date(eventDate);
            oneDayBefore.setDate(oneDayBefore.getDate() - 1);
            oneDayBefore.setHours(20, 0, 0, 0);
            
            if (shouldSendNotification(now, oneDayBefore, eventId, '1day', notificationHistory)) {
                sendEventNotification(event, '📅 明日のリマインド', `${event.name}は明日です！チケットや持ち物の確認をお忘れなく。`);
                saveNotificationHistory(eventId, '1day');
            }
        }
        
        // 当日朝の通知（朝7時）
        if (setting.morning) {
            const morningTime = new Date(eventDate);
            morningTime.setHours(7, 0, 0, 0);
            
            if (shouldSendNotification(now, morningTime, eventId, 'morning', notificationHistory)) {
                const venue = event.venue || '会場';
                const time = event.time || '';
                sendEventNotification(event, '🌅 今日のイベント', `今日は${event.name}の日です！\n📍 ${venue} ${time}\nいってらっしゃい！`);
                saveNotificationHistory(eventId, 'morning');
            }
        }
    });
}

// 通知を送信すべきかチェック
function shouldSendNotification(now, targetTime, eventId, type, history) {
    // 目標時刻の前後10分以内かチェック
    const timeDiff = now - targetTime;
    const tenMinutes = 10 * 60 * 1000;
    
    // 目標時刻から10分以内で、かつまだ送信していない
    if (timeDiff >= 0 && timeDiff <= tenMinutes) {
        const key = `${eventId}-${type}`;
        return !history[key];
    }
    
    return false;
}

// イベント通知を送信
function sendEventNotification(event, title, message) {
    const notification = new Notification(title, {
        body: message,
        icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">🎪</text></svg>',
        tag: `${event.id || event.name}-notification`,
        requireInteraction: false,
        data: {
            eventId: event.id || event.name,
            eventName: event.name,
            eventDate: event.date,
            eventTime: event.time
        }
    });
    
    // 通知をクリックした時の処理
    notification.onclick = function(e) {
        e.preventDefault();
        window.focus();
        
        // イベント詳細を表示
        const allEvents = getAllEvents();
        const eventIndex = allEvents.findIndex(ev => 
            (ev.id || ev.name) === (event.id || event.name)
        );
        
        if (eventIndex >= 0) {
            showEventDetail(eventIndex);
        }
        
        notification.close();
    };
    
    console.log(`📢 通知送信: ${title} - ${message}`);
}

        // 通知履歴を取得
        function getNotificationHistory() {
            const saved = localStorage.getItem('notificationHistory');
            if (saved) {
                return JSON.parse(saved);
            }
            return {};
        }

        // 通知履歴を保存
        function saveNotificationHistory(eventId, type) {
            const history = getNotificationHistory();
            const key = `${eventId}-${type}`;
            history[key] = new Date().toISOString();
            localStorage.setItem('notificationHistory', JSON.stringify(history));
        }

        // 通知履歴をクリア（テスト用）
        function clearNotificationHistory() {
            localStorage.removeItem('notificationHistory');
            console.log('🗑️ 通知履歴をクリアしました');
        }

        // テスト通知を送信（開発用）
        function sendTestNotification() {
            if (Notification.permission !== 'granted') {
                alert('通知権限が許可されていません。ブラウザの設定で通知を許可してください。');
                return;
            }
            
            const notification = new Notification('🧪 テスト通知', {
                body: 'これはテスト通知です。実際のイベント通知はこのように表示されます。',
                icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">🔔</text></svg>',
                tag: 'test-notification'
            });
            
            notification.onclick = function() {
                window.focus();
                notification.close();
            };
        }

        // アプリ起動時に過去の未送信通知をチェック
        function checkMissedNotifications() {
            if (Notification.permission !== 'granted') {
                return;
            }
            
            console.log('🔍 未送信の通知をチェック中...');
            
            const now = new Date();
            const allEvents = getAllEvents();
            const notificationHistory = getNotificationHistory();
            let missedCount = 0;
            
            allEvents.forEach(event => {
                const eventId = event.id || event.name;
                const setting = getNotificationSetting(eventId);
                
                // 通知が無効ならスキップ
                if (!setting.enabled) {
                    return;
                }
                
                const eventDate = new Date(event.date);
                
                // 3日前の通知をチェック
                if (setting.threeDaysBefore) {
                    const threeDaysBefore = new Date(eventDate);
                    threeDaysBefore.setDate(threeDaysBefore.getDate() - 3);
                    threeDaysBefore.setHours(9, 0, 0, 0);
                    
                    // 通知時刻を過ぎているか、かつ未送信か
                    if (now > threeDaysBefore && !notificationHistory[`${eventId}-3days`]) {
                        // イベントがまだ終わっていない場合のみ通知
                        if (now < eventDate) {
                            sendEventNotification(event, '📅 リマインド（遅延）', `${event.name}まであと数日です！準備を始めましょう。`);
                            saveNotificationHistory(eventId, '3days');
                            missedCount++;
                        }
                    }
                }
                
                // 1日前の通知をチェック
                if (setting.oneDayBefore) {
                    const oneDayBefore = new Date(eventDate);
                    oneDayBefore.setDate(oneDayBefore.getDate() - 1);
                    oneDayBefore.setHours(20, 0, 0, 0);
                    
                    if (now > oneDayBefore && !notificationHistory[`${eventId}-1day`]) {
                        if (now < eventDate) {
                            const hoursLeft = Math.round((eventDate - now) / (1000 * 60 * 60));
                            sendEventNotification(event, '📅 リマインド（遅延）', `${event.name}まであと${hoursLeft}時間です！準備はOKですか？`);
                            saveNotificationHistory(eventId, '1day');
                            missedCount++;
                        }
                    }
                }
                
                // 当日朝の通知をチェック
                if (setting.morning) {
                    const morningTime = new Date(eventDate);
                    morningTime.setHours(7, 0, 0, 0);
                    
                    if (now > morningTime && !notificationHistory[`${eventId}-morning`]) {
                        // イベント開始時刻を取得
                        const eventTime = event.time || '';
                        const timeMatch = eventTime.match(/(\d+):(\d+)/);
                        let eventStartTime = new Date(eventDate);
                        if (timeMatch) {
                            eventStartTime.setHours(parseInt(timeMatch[1]), parseInt(timeMatch[2]));
                        }
                        
                        // イベントがまだ始まっていない場合のみ通知
                        if (now < eventStartTime) {
                            sendEventNotification(event, '🌅 今日のイベント', `今日は${event.name}の日です！\n📍 ${event.venue || ''} ${event.time || ''}\nいってらっしゃい！`);
                            saveNotificationHistory(eventId, 'morning');
                            missedCount++;
                        }
                    }
                }
            });
            
            if (missedCount > 0) {
                console.log(`✅ ${missedCount}件の未送信通知を送信しました`);
            } else {
                console.log('✅ 未送信の通知はありません');
            }
        }
        
        function init() {
            loadCustomEvents();
            loadChecklists();
            loadHomeLocation();
            loadTags();
            loadTheme();  // ← この行を追加
            loadNotificationSettings();  
            // 通知権限をリクエスト
            requestNotificationPermission();
            renderNextEventCountdown();
            renderSummary();
            renderTagFilter();
            renderScheduleOptimization();
            renderView();

            // 🆕 アプリ起動時に未送信の通知をチェック
            checkMissedNotifications();
            
            // 通知チェックを定期的に実行（1分ごと）
            setInterval(() => {
                renderNextEventCountdown();
                checkAndSendNotifications();
            }, 60000);
        
            // 初回の通知チェック
            checkAndSendNotifications();
        }

        function getDaysUntil(dateStr) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const eventDate = new Date(dateStr);
            eventDate.setHours(0, 0, 0, 0);
            const diffTime = eventDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        function getCountdownText(days) {
            if (days < 0) return '終了';
            if (days === 0) return '今日';
            if (days === 1) return '明日';
            if (days <= 7) return `あと${days}日`;
            if (days <= 30) return `あと${days}日`;
            const weeks = Math.floor(days / 7);
            return `あと${weeks}週間`;
        }
        
        function getCountdownClass(days) {
            if (days < 0) return 'past';
            if (days === 0) return 'today';
            if (days === 1) return 'tomorrow';
            if (days <= 7) return 'soon';
            return 'upcoming';
        }
        
        function renderNextEventCountdown() {
            const allEvents = getAllEvents();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const upcomingEvents = allEvents
                .filter(e => {
                    const eventDate = new Date(e.date);
                    eventDate.setHours(0, 0, 0, 0);
                    return eventDate >= today;
                })
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const countdownDiv = document.getElementById('nextEventCountdown');
            
            if (upcomingEvents.length === 0) {
                countdownDiv.style.display = 'none';
                return;
            }
            
            const nextEvent = upcomingEvents[0];
            const days = getDaysUntil(nextEvent.date);
            
            let countdownHTML = `
                <h3>📅 次のイベント</h3>
                <div class="event-name">${nextEvent.name}</div>
            `;
            
            if (days === 0) {
                countdownHTML += `
                    <div class="countdown-display">
                        <div class="countdown-item">
                            <div class="countdown-number">🎉</div>
                            <div class="countdown-label">今日開催！</div>
                        </div>
                    </div>
                `;
            } else {
                const eventDate = new Date(nextEvent.date);
                const now = new Date();
                const diff = eventDate - now;
                
                const daysLeft = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hoursLeft = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutesLeft = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                
                countdownHTML += `
                    <div class="countdown-display">
                        <div class="countdown-item">
                            <div class="countdown-number">${daysLeft}</div>
                            <div class="countdown-label">日</div>
                        </div>
                        <div class="countdown-item">
                            <div class="countdown-number">${hoursLeft}</div>
                            <div class="countdown-label">時間</div>
                        </div>
                        <div class="countdown-item">
                            <div class="countdown-number">${minutesLeft}</div>
                            <div class="countdown-label">分</div>
                        </div>
                    </div>
                `;
            }
            
            countdownDiv.innerHTML = countdownHTML;
            countdownDiv.style.display = 'block';
        }
        
        document.getElementById('artistSearchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase().trim();
            const resultsDiv = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const results = [];
            eventsData.forEach(event => {
                if (event.artists) {
                    event.artists.forEach(artist => {
                        if (artist.ja.toLowerCase().includes(searchTerm) || 
                            artist.en.toLowerCase().includes(searchTerm)) {
                            results.push({
                                artist: artist,
                                event: event
                            });
                        }
                    });
                }
            });
            
            if (results.length === 0) {
                resultsDiv.innerHTML = '<div class="no-results">該当するアーティストが見つかりませんでした</div>';
            } else {
                let html = '<h3 style="margin-bottom: 15px; color: #667eea;">検索結果: ' + results.length + '件</h3>';
                const grouped = {};
                
                results.forEach(r => {
                    const key = r.artist.ja + '/' + r.artist.en;
                    if (!grouped[key]) {
                        grouped[key] = {
                            artist: r.artist,
                            events: []
                        };
                    }
                    grouped[key].events.push(r.event);
                });
                
                Object.values(grouped).forEach(item => {
                    html += `
                        <div class="result-item">
                            <h3>🎤 ${item.artist.ja} / ${item.artist.en}</h3>
                            ${item.events.map(e => `
                                <p><strong>📅 ${formatDate(e.date)}</strong> - ${e.name}</p>
                                <p style="margin-left: 20px;">🕐 ${e.time} | 📍 ${e.venue}</p>
                            `).join('')}
                        </div>
                    `;
                });
                
                resultsDiv.innerHTML = html;
            }
        });
        
        function renderSummary() {
            const allEvents = getAllEvents();
            const totalEvents = allEvents.filter(e => !e.name.includes('交通費') && !e.name.includes('グッズ')).length;
            const totalCost = allEvents.reduce((sum, e) => sum + e.price, 0) + 67609;
            const upcomingEvents = allEvents.filter(e => e.status === '開始前' || e.isCustom).length;
            const notificationsOn = Object.values(notificationSettings).filter(s => s.enabled).length;
            
            document.getElementById('summary').innerHTML = `
                <div class="summary-card">
                    <h3>総イベント数</h3>
                    <div class="value">${totalEvents}</div>
                </div>
                <div class="summary-card">
                    <h3>合計金額</h3>
                    <div class="value">¥${totalCost.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <h3>開始前</h3>
                    <div class="value">${upcomingEvents}</div>
                </div>
                <div class="summary-card">
                    <h3>通知ON</h3>
                    <div class="value">${notificationsOn}</div>
                </div>
            `;
        }
        
        function renderView() {
            if (currentView === 'calendar') {
                renderCalendarView();
            } else {
                renderListView();
            }
        }
        
        function renderCalendarView() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            
            const allEvents = getAllEvents();
            let filtered = allEvents.filter(e => {
                if (searchTerm && !e.name.toLowerCase().includes(searchTerm)) return false;
                if (dateFilter && e.date !== dateFilter) return false;
                
                if (activeTagFilter) {
                    const eventId = e.id || e.name;
                    const tags = getTags(eventId);
                    if (!tags.includes(activeTagFilter)) return false;
                }
                
                return true;
            });
            
            const grouped = {};
            filtered.forEach(event => {
                if (!grouped[event.date]) {
                    grouped[event.date] = [];
                }
                grouped[event.date].push(event);
            });
            
            let html = '';
            Object.keys(grouped).sort().forEach(date => {
                const events = grouped[date];
                const dayTotal = events.reduce((sum, e) => sum + e.price, 0);
                
                html += `
                    <div class="day-card">
                        <div class="day-header">
                            <div class="day-date">📅 ${formatDate(date)}</div>
                            <div class="day-total">💰 ¥${dayTotal.toLocaleString()}</div>
                        </div>
                        <div class="events-grid">
                            ${events.map((event) => renderEventCard(event)).join('')}
                        </div>
                    </div>
                `;
            });
            
            const calendarView = document.getElementById('calendarView');
            if (html) {
                calendarView.innerHTML = html;
            } else {
                calendarView.innerHTML = '<p style="text-align:center;color:white;padding:50px;">イベントが見つかりません</p>';
            }
        }
        
        function renderEventCard(event) {
            const allEvents = getAllEvents();
            const eventIndex = allEvents.indexOf(event);
            const type = event.name.includes('EXPO') ? 'expo' : 
                        event.name.includes('STAGE') ? 'stage' : 'other';
            
            const eventId = event.id || event.name;
            const checklist = getChecklist(eventId);
            const completedCount = checklist.filter(item => item.completed).length;
            const checklistBadge = checklist.length > 0 ? 
                `<span class="checklist-badge">✓ ${completedCount}/${checklist.length}</span>` : '';
            
            const tags = getTags(eventId);
            const tagsDisplay = tags.length > 0 ? 
                `<div class="tags-container" style="margin-top: 10px;">
                    ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>` : '';
            
            const customBadge = event.isCustom ? '<span class="custom-event-badge">マイ予定</span>' : '';
            const editButtons = event.isCustom ? `
                <div class="event-actions">
                    <button class="btn-small btn-edit" onclick="editCustomEvent('${event.id}')">✏️ 編集</button>
                    <button class="btn-small btn-delete" onclick="deleteCustomEvent('${event.id}')">🗑️ 削除</button>
                </div>
            ` : '';
            
            const days = getDaysUntil(event.date);
            const countdownText = getCountdownText(days);
            const countdownClass = getCountdownClass(days);
            const countdownBadge = `<span class="countdown-badge ${countdownClass}">${countdownText}</span>`;
            
            function renderEventCard(event) {
            const allEvents = getAllEvents();
            const eventIndex = allEvents.indexOf(event);
            const type = event.name.includes('EXPO') ? 'expo' : 
                        event.name.includes('STAGE') ? 'stage' : 'other';
            
            const eventId = event.id || event.name;
            const checklist = getChecklist(eventId);
            const completedCount = checklist.filter(item => item.completed).length;
            const checklistBadge = checklist.length > 0 ? 
                `<span class="checklist-badge">✓ ${completedCount}/${checklist.length}</span>` : '';
            
            const tags = getTags(eventId);
            const tagsDisplay = tags.length > 0 ? 
                `<div class="tags-container" style="margin-top: 10px;">
                    ${tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                </div>` : '';
            
            const customBadge = event.isCustom ? '<span class="custom-event-badge">マイ予定</span>' : '';
            const editButtons = event.isCustom ? `
                <div class="event-actions">
                    <button class="btn-small btn-edit" onclick="editCustomEvent('${event.id}')">✏️ 編集</button>
                    <button class="btn-small btn-delete" onclick="deleteCustomEvent('${event.id}')">🗑️ 削除</button>
                </div>
            ` : '';
            
            const days = getDaysUntil(event.date);
            const countdownText = getCountdownText(days);
            const countdownClass = getCountdownClass(days);
            const countdownBadge = `<span class="countdown-badge ${countdownClass}">${countdownText}</span>`;
            
            // 通知バッジ
            const notifSetting = getNotificationSetting(eventId);
            const notificationBadge = notifSetting.enabled ? 
                '<span class="notification-badge">🔔</span>' : '';
            
    return `
        <div class="event-card ${type}" onclick="showEventDetail(${eventIndex})">
            ${notificationBadge}
            <div class="event-title">${event.name}${customBadge}${checklistBadge}</div>
            ${event.status && event.status !== '---------' ? `<span class="status-badge">${event.status}</span>` : ''}
            ${countdownBadge}
            ${tagsDisplay}
            <div class="event-details">
                ${event.time && event.time !== '---------' ? `
                <div class="event-detail">
                    <span class="icon">🕐</span>
                    <span class="label">${event.time}</span>
                </div>
                ` : ''}
                ${event.venue && event.venue !== '---------' ? `
                <div class="event-detail">
                    <span class="icon">📍</span>
                    <span class="label">${event.venue}</span>
                </div>
                ` : ''}
            </div>
            <div class="event-price">¥${event.price.toLocaleString()}</div>
            ${editButtons}
        </div>
    `;
}

            return `
                <div class="event-card ${type}" onclick="showEventDetail(${eventIndex})">
                    <div class="event-title">${event.name}${customBadge}${checklistBadge}</div>
                    ${event.status && event.status !== '---------' ? `<span class="status-badge">${event.status}</span>` : ''}
                    ${countdownBadge}
                    ${tagsDisplay}
                    <div class="event-details">
                        ${event.time && event.time !== '---------' ? `
                        <div class="event-detail">
                            <span class="icon">🕐</span>
                            <span class="label">${event.time}</span>
                        </div>
                        ` : ''}
                        ${event.venue && event.venue !== '---------' ? `
                        <div class="event-detail">
                            <span class="icon">📍</span>
                            <span class="label">${event.venue}</span>
                        </div>
                        ` : ''}
                    </div>
                    <div class="event-price">¥${event.price.toLocaleString()}</div>
                    ${editButtons}
                </div>
            `;
        }
        
        function renderListView() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const dateFilter = document.getElementById('dateFilter').value;
            
            const allEvents = getAllEvents();
            let filtered = allEvents.filter(e => {
                if (searchTerm && !e.name.toLowerCase().includes(searchTerm)) return false;
                if (dateFilter && e.date !== dateFilter) return false;
                return true;
            });
            // 時系列順にソート
            filtered.sort((a, b) => {
                const getDateTime = (event) => {
                    if (!event.time) {
                        return new Date(event.date + ' 00:00:00');
                    }
                    
                    let timeStr = event.time;
                    
                    // パターン1: "9時~18時" のような形式
                    const hourMatch = timeStr.match(/(\d+)時/);
                    if (hourMatch) {
                        const hour = hourMatch[1].padStart(2, '0');
                        timeStr = `${hour}:00`;
                    } else {
                        // パターン2: "17:00(場)18:30(演)" のような形式
                        const timeMatch = timeStr.match(/(\d+):(\d+)/);
                        if (timeMatch) {
                            timeStr = `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`;
                        } else {
                            timeStr = '00:00';
                        }
                    }
                    
                    return new Date(event.date + ' ' + timeStr + ':00');
                };
                return getDateTime(a) - getDateTime(b);
            });
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>イベント名</th>
                            <th>状況</th>
                            <th>日付</th>
                            <th>時間</th>
                            <th>会場</th>
                            <th>料金</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map((event) => {
                            const allEvs = getAllEvents();
                            const idx = allEvs.indexOf(event);
                            const customBadge = event.isCustom ? ' <span style="color:#48c774">📝</span>' : '';
                            return `
                            <tr onclick="showEventDetail(${idx})">
                                <td><strong>${event.name}${customBadge}</strong></td>
                                <td>${event.status || '-'}</td>
                                <td>${formatDate(event.date)}</td>
                                <td>${event.time || '-'}</td>
                                <td>${event.venue || '-'}</td>
                                <td><strong>¥${event.price.toLocaleString()}</strong></td>
                            </tr>
                        `}).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('listView').innerHTML = html;
        }
        
        function showEventDetail(index) {
            const allEvents = getAllEvents();
            const event = allEvents[index];
            const modal = document.getElementById('eventModal');
            const eventId = event.id || event.name;
            
            document.getElementById('modalTitle').textContent = event.name;
            document.getElementById('modalDate').textContent = formatDate(event.date);
            
            let bodyHtml = `
                <div class="modal-info-grid">
                    ${event.status && event.status !== '---------' ? `
                    <div class="modal-info-item">
                        <div class="icon">🎫</div>
                        <div class="content">
                            <h4>チケット状況</h4>
                            <p>${event.status}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${event.time && event.time !== '---------' ? `
                    <div class="modal-info-item">
                        <div class="icon">🕐</div>
                        <div class="content">
                            <h4>開催時間</h4>
                            <p>${event.time}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${event.venue && event.venue !== '---------' ? `
                    <div class="modal-info-item">
                        <div class="icon">📍</div>
                        <div class="content">
                            <h4>会場</h4>
                            <p>${event.venue}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    <div class="modal-info-item">
                        <div class="icon">💰</div>
                        <div class="content">
                            <h4>料金</h4>
                            <p>¥${event.price.toLocaleString()}</p>
                        </div>
                    </div>
                    
                    ${event.description ? `
                    <div class="modal-info-item">
                        <div class="icon">📝</div>
                        <div class="content">
                            <h4>詳細</h4>
                            <p>${event.description}</p>
                        </div>
                    </div>
                    ` : ''}
                    
                    ${event.artists ? `
                    <div class="modal-info-item">
                        <div class="icon">🎤</div>
                        <div class="content">
                            <h4>出演アーティスト (${event.artists.length}名)</h4>
                            <div class="artist-list">
                                ${event.artists.map(artist => `
                                    <span class="artist-badge">${artist.ja}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                ${renderChecklistSection(eventId)}
                
                ${renderMapSection(event)}
                
                ${renderWeatherSection(event)}
                
                ${renderTagsSection(eventId)}
                
                ${event.isCustom ? `
                    <div class="form-actions">
                        <button class="btn-secondary btn-edit" onclick="closeModal(); editCustomEvent('${event.id}')">✏️ 編集</button>
                        <button class="btn-secondary btn-delete" onclick="closeModal(); deleteCustomEvent('${event.id}')">🗑️ 削除</button>
                    </div>
                ` : ''}
                
                ${event.officialUrl ? `
                    <a href="${event.officialUrl}" target="_blank" class="official-link">
                        🔗 公式サイトで詳細を見る
                    </a>
                ` : ''}
            `;
            
            document.getElementById('modalBody').innerHTML = bodyHtml;
            modal.style.display = 'block';
        }
        
        // チェックリストセクションをレンダリング
        function renderChecklistSection(eventId) {
            const checklist = getChecklist(eventId);
            const completedCount = checklist.filter(item => item.completed).length;
            const totalCount = checklist.length;
            const progress = totalCount > 0 ? (completedCount / totalCount * 100).toFixed(0) : 0;
            
            return `
                <div class="checklist-section">
                    <h4>
                        ✓ 準備チェックリスト
                        ${totalCount > 0 ? `<span style="font-size: 0.9em; color: #999;">(${completedCount}/${totalCount}完了)</span>` : ''}
                    </h4>
                    
                    ${totalCount > 0 ? `
                        <div class="checklist-progress">
                            <div style="color: #667eea; font-weight: bold;">${progress}% 完了</div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="checklist-items" id="checklistItems-${eventId}">
                        ${checklist.map((item, index) => `
                            <div class="checklist-item ${item.completed ? 'completed' : ''}">
                                <input type="checkbox" 
                                       class="checklist-checkbox" 
                                       ${item.completed ? 'checked' : ''}
                                       onchange="toggleChecklistItem('${eventId}', ${index})">
                                <span class="checklist-text">${item.text}</span>
                                <button class="checklist-delete" onclick="deleteChecklistItem('${eventId}', ${index})">削除</button>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="add-checklist-form">
                        <input type="text" 
                               class="add-checklist-input" 
                               id="checklistInput-${eventId}" 
                               placeholder="例: チケットを印刷する"
                               onkeypress="if(event.key === 'Enter') addChecklistItem('${eventId}')">
                        <button class="add-checklist-btn" onclick="addChecklistItem('${eventId}')">追加</button>
                    </div>
                </div>
            `;
        }
        
        // チェックリストアイテムを追加
        function addChecklistItem(eventId) {
            const input = document.getElementById(`checklistInput-${eventId}`);
            const text = input.value.trim();
            
            if (!text) return;
            
            const checklist = getChecklist(eventId);
            checklist.push({
                text: text,
                completed: false,
                createdAt: new Date().toISOString()
            });
            
            saveChecklists();
            input.value = '';
            
            // モーダルを再レンダリング
            const allEvents = getAllEvents();
            const eventIndex = allEvents.findIndex(e => (e.id || e.name) === eventId);
            if (eventIndex >= 0) {
                showEventDetail(eventIndex);
            }
            
            // カードも更新
            renderView();
        }
        
        // チェックリストアイテムをトグル
        function toggleChecklistItem(eventId, index) {
            const checklist = getChecklist(eventId);
            checklist[index].completed = !checklist[index].completed;
            saveChecklists();
            
            // モーダルを再レンダリング
            const allEvents = getAllEvents();
            const eventIndex = allEvents.findIndex(e => (e.id || e.name) === eventId);
            if (eventIndex >= 0) {
                showEventDetail(eventIndex);
            }
            
            // カードも更新
            renderView();
        }
        
        // チェックリストアイテムを削除
        function deleteChecklistItem(eventId, index) {
            if (!confirm('このチェック項目を削除しますか？')) return;
            
            const checklist = getChecklist(eventId);
            checklist.splice(index, 1);
            saveChecklists();
            
            // モーダルを再レンダリング
            const allEvents = getAllEvents();
            const eventIndex = allEvents.findIndex(e => (e.id || e.name) === eventId);
            if (eventIndex >= 0) {
                showEventDetail(eventIndex);
            }
            
            // カードも更新
            renderView();
        }
        
        // マップセクションをレンダリング
        function renderMapSection(event) {
        // 会場情報を取得（より具体的なものを優先）
        let venueKey = null;
        
        if (event.venue) {
            // キーの長さでソート（長い=具体的なものを優先）
            const sortedKeys = Object.keys(venueDatabase).sort((a, b) => b.length - a.length);
            
            venueKey = sortedKeys.find(key => 
                event.venue.includes(key.split('&')[0].trim())
            );
        }
            
            if (!venueKey && (!event.venue || event.venue === '---------')) {
                return '';
            }
            
            const venueInfo = venueDatabase[venueKey];
            
            // 基本的なマップセクション
            let mapHTML = `
                <div class="map-section">
                    <h4>🗺️ アクセス・地図</h4>
            `;
            
            // 会場情報がある場合
            if (venueInfo) {
                const encodedAddress = encodeURIComponent(venueInfo.address);
                const encodedVenue = encodeURIComponent(venueInfo.name);
                const fromLocation = homeLocation ? encodeURIComponent(homeLocation) : '';
                
                mapHTML += `
                    <div class="venue-info">
                        <div class="venue-info-item">
                            <span class="venue-info-icon">📍</span>
                            <div class="venue-info-text">
                                <strong>住所</strong>
                                ${venueInfo.address}
                            </div>
                        </div>
                        <div class="venue-info-item">
                            <span class="venue-info-icon">🚃</span>
                            <div class="venue-info-text">
                                <strong>最寄り駅</strong>
                                ${venueInfo.station} ${venueInfo.walkTime}
                            </div>
                        </div>
                        <div class="venue-info-item">
                            <span class="venue-info-icon">💡</span>
                            <div class="venue-info-text">
                                <strong>アドバイス</strong>
                                ${venueInfo.tips}
                            </div>
                        </div>
                    </div>
                    
                    <div class="map-buttons">
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodedAddress}" 
                           target="_blank" 
                           class="map-btn google-maps">
                            🗺️ Google Maps
                        </a>
                        
                        ${fromLocation ? `
                        <a href="https://www.google.com/maps/dir/?api=1&origin=${fromLocation}&destination=${encodedAddress}&travelmode=transit" 
                           target="_blank" 
                           class="map-btn google-maps">
                            🚃 経路検索（自宅から）
                        </a>
                        ` : ''}
                        
                        <a href="https://transit.yahoo.co.jp/search/result?from=&to=${encodedVenue}" 
                           target="_blank" 
                           class="map-btn yahoo-transit">
                            🚉 Yahoo!乗換案内
                        </a>
                        
                        <a href="https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${venueInfo.lat},${venueInfo.lng}" 
                           target="_blank" 
                           class="map-btn street-view">
                            👁️ ストリートビュー
                        </a>
                    </div>
                    
                    ${!homeLocation ? `
                    <div class="home-location-setting">
                        <label>🏠 自宅住所を設定すると、経路検索がもっと便利に！</label>
                        <input type="text" 
                               id="homeLocationInput" 
                               placeholder="例: 東京都渋谷区"
                               value="${homeLocation}">
                        <small>設定すると「自宅からの経路」ボタンが表示されます</small>
                        <button onclick="saveHomeLocationFromInput()" 
                                style="margin-top: 10px; padding: 8px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                            保存
                        </button>
                    </div>
                    ` : `
                    <div class="travel-time">
                        🏠 自宅: ${homeLocation} 
                        <span style="cursor: pointer; margin-left: 10px;" onclick="clearHomeLocation()">✕</span>
                    </div>
                    `}
                `;
            } else {
                // カスタムイベントなど、会場情報がない場合
                const searchQuery = event.venue ? encodeURIComponent(event.venue) : '';
                mapHTML += `
                    <div class="map-buttons">
                        <a href="https://www.google.com/maps/search/?api=1&query=${searchQuery}" 
                           target="_blank" 
                           class="map-btn google-maps">
                            🗺️ 会場を検索
                        </a>
                    </div>
                `;
            }
            
            mapHTML += `</div>`;
            return mapHTML;
        }
        
        // 自宅住所を入力から保存
        function saveHomeLocationFromInput() {
            const input = document.getElementById('homeLocationInput');
            if (input && input.value.trim()) {
                saveHomeLocation(input.value.trim());
                alert('自宅住所を保存しました！');
                
                // モーダルを再描画
                const modal = document.getElementById('eventModal');
                if (modal.style.display === 'block') {
                    // 現在開いているイベントを再表示
                    location.reload(); // 簡易的にリロード
                }
            }
        }
        
        // 自宅住所をクリア
        function clearHomeLocation() {
            if (confirm('自宅住所の設定を削除しますか？')) {
                saveHomeLocation('');
                alert('自宅住所を削除しました');
                location.reload();
            }
        }
        
        // タグセクションをレンダリング
        function renderTagsSection(eventId) {
            const tags = getTags(eventId);
            
            return `
                <div class="tags-section">
                    <h4>🏷️ タグ</h4>
                    
                    ${tags.length > 0 ? `
                        <div class="tags-container">
                            ${tags.map(tag => `
                                <span class="tag removable" onclick="event.stopPropagation(); removeTag('${eventId}', '${tag.replace(/'/g, "\\'")}')">
                                    ${tag}
                                    <span class="tag-remove">×</span>
                                </span>
                            `).join('')}
                        </div>
                    ` : '<p style="color: #999; font-size: 0.9em;">タグがありません</p>'}
                    
                    <div class="tag-input-form">
                        <input type="text" 
                               class="tag-input" 
                               id="tagInput-${eventId}" 
                               placeholder="タグを入力..."
                               onkeypress="if(event.key === 'Enter') addTag('${eventId}')">
                        <button class="add-checklist-btn" onclick="addTag('${eventId}')">追加</button>
                    </div>
                    
                    <div class="tag-suggestions">
                        <small style="color: #999; display: block; margin-bottom: 8px;">よく使うタグ:</small>
                        ${tagSuggestions.map(tag => `
                            <span class="tag-suggestion" onclick="addSuggestedTag('${eventId}', '${tag.replace(/'/g, "\\'")}')">
                                ${tag}
                            </span>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        // タグを追加
        function addTag(eventId) {
            const input = document.getElementById(`tagInput-${eventId}`);
            const tagText = input.value.trim();
            
            if (!tagText) return;
            
            const tags = getTags(eventId);
            if (tags.includes(tagText)) {
                alert('このタグは既に追加されています');
                return;
            }
            
            tags.push(tagText);
            saveTags();
            input.value = '';
            
            // モーダルとビューを更新
            const allEvents = getAllEvents();
            const eventIndex = allEvents.findIndex(e => (e.id || e.name) === eventId);
            if (eventIndex >= 0) {
                showEventDetail(eventIndex);
            }
            renderTagFilter();
            renderView();
        }
        
        // 提案タグを追加
        function addSuggestedTag(eventId, tag) {
            const tags = getTags(eventId);
            if (tags.includes(tag)) {
                alert('このタグは既に追加されています');
                return;
            }
            
            tags.push(tag);
            saveTags();
            
            // モーダルとビューを更新
            const allEvents = getAllEvents();
            const eventIndex = allEvents.findIndex(e => (e.id || e.name) === eventId);
            if (eventIndex >= 0) {
                showEventDetail(eventIndex);
            }
            renderTagFilter();
            renderView();
        }
        
        // タグを削除
        function removeTag(eventId, tag) {
            const tags = getTags(eventId);
            const index = tags.indexOf(tag);
            if (index > -1) {
                tags.splice(index, 1);
                saveTags();
                
                // モーダルとビューを更新
                const allEvents = getAllEvents();
                const eventIndex = allEvents.findIndex(e => (e.id || e.name) === eventId);
                if (eventIndex >= 0) {
                    showEventDetail(eventIndex);
                }
                renderTagFilter();
                renderView();
            }
        }
        
        // タグフィルターをレンダリング
        function renderTagFilter() {
            const allTags = getAllTags();
            const filterDiv = document.getElementById('tagFilter');
            
            if (allTags.length === 0) {
                filterDiv.style.display = 'none';
                return;
            }
            
            let html = `
                <div class="tag-filter-item ${!activeTagFilter ? 'active' : ''}" onclick="setTagFilter(null)">
                    🔍 すべて
                </div>
            `;
            
            allTags.forEach(tag => {
                html += `
                    <div class="tag-filter-item ${activeTagFilter === tag ? 'active' : ''}" 
                         onclick="setTagFilter('${tag.replace(/'/g, "\\'")}')">
                        ${tag}
                    </div>
                `;
            });
            
            filterDiv.innerHTML = html;
            filterDiv.style.display = 'flex';
        }
        
        // タグフィルターを設定
        function setTagFilter(tag) {
            activeTagFilter = tag;
            renderTagFilter();
            renderView();
        }
        
        // スケジュール最適化を表示
        function renderScheduleOptimization() {
            const allEvents = getAllEvents();
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // 未来のイベントのみ
            const upcomingEvents = allEvents
                .filter(e => new Date(e.date) >= today)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            
            if (upcomingEvents.length === 0) {
                document.getElementById('scheduleOptimization').style.display = 'none';
                return;
            }
            
            // 時間が重複しているイベントを検出
            const conflicts = [];
            for (let i = 0; i < upcomingEvents.length; i++) {
                for (let j = i + 1; j < upcomingEvents.length; j++) {
                    if (upcomingEvents[i].date === upcomingEvents[j].date) {
                        // 同じ日のイベントで時間が重複している可能性
                        conflicts.push({
                            event1: upcomingEvents[i],
                            event2: upcomingEvents[j]
                        });
                    }
                }
            }
            
            // 連続イベントを検出（2日以上連続）
            const consecutiveDays = [];
            for (let i = 0; i < upcomingEvents.length - 1; i++) {
                const date1 = new Date(upcomingEvents[i].date);
                const date2 = new Date(upcomingEvents[i + 1].date);
                const diffDays = (date2 - date1) / (1000 * 60 * 60 * 24);
                
                if (diffDays === 1) {
                    consecutiveDays.push({
                        events: [upcomingEvents[i], upcomingEvents[i + 1]]
                    });
                }
            }
            
            const optDiv = document.getElementById('scheduleOptimization');
            let html = '<h3>📅 スケジュール最適化</h3>';
            
            // 重複警告
            if (conflicts.length > 0) {
                html += '<div class="conflict-warning">';
                html += '<h4>⚠️ 時間が重複している可能性があります</h4>';
                conflicts.forEach(c => {
                    html += `<p>• ${c.event1.name} と ${c.event2.name} が同じ日（${formatDate(c.event1.date)}）</p>`;
                });
                html += '</div>';
            }
            
            html += '<div class="optimization-options">';
            
            // 連続イベントのアドバイス
            if (consecutiveDays.length > 0) {
                html += `
                    <div class="optimization-card">
                        <h4>🏨 宿泊を検討してみては？</h4>
                        <p>連続するイベントがあります。宿泊すると移動が楽になります。</p>
                        <span class="optimization-badge info">${consecutiveDays.length}件の連続イベント</span>
                    </div>
                `;
            }
            
            // 予算アドバイス
            const totalCost = upcomingEvents.reduce((sum, e) => sum + e.price, 0);
            if (totalCost > 50000) {
                html += `
                    <div class="optimization-card">
                        <h4>💰 予算管理のアドバイス</h4>
                        <p>今後のイベントで合計 ¥${totalCost.toLocaleString()} の支出が予定されています。</p>
                        <span class="optimization-badge warning">高額</span>
                    </div>
                `;
            }
            
            // 準備期間のアドバイス
            if (upcomingEvents.length > 0) {
                const nextEvent = upcomingEvents[0];
                const daysUntil = getDaysUntil(nextEvent.date);
                
                if (daysUntil <= 7 && daysUntil > 0) {
                    html += `
                        <div class="optimization-card">
                            <h4>⏰ もうすぐです！</h4>
                            <p>${nextEvent.name} まであと ${daysUntil}日。チェックリストの確認をお忘れなく！</p>
                            <span class="optimization-badge">準備期間</span>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            
            optDiv.innerHTML = html;
            optDiv.style.display = 'block';
        }
        
        // 天気予報セクションをレンダリング
        // 天気予報セクションをレンダリング（詳細版）
        function renderWeatherSection(event) {
            const eventDate = new Date(event.date);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            eventDate.setHours(0, 0, 0, 0);
            
            const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));
            
            // 過去のイベントまたは16日以上先のイベントは天気予報を表示しない
            if (daysUntil < 0 || daysUntil > 16) {
                return '';
            }
            
            // 会場の位置情報を取得
            const venueKey = Object.keys(venueDatabase).find(key => 
                event.venue && event.venue.includes(key.split('&')[0].trim())
            );
            
            const venueInfo = venueDatabase[venueKey];
            const lat = venueInfo ? venueInfo.lat : 35.6812;
            const lon = venueInfo ? venueInfo.lng : 139.7671;
            const eventId = (event.id || event.name).replace(/\s/g, '-').replace(/['"]/g, '');
            const eventDateStr = event.date;
            
            // 天気予報を別のscriptタグで非同期実行
            setTimeout(() => {
                fetchDetailedWeather(eventId, lat, lon, eventDateStr, daysUntil);
            }, 100);
            
            return `
                <div class="weather-section" id="weather-${eventId}">
                    <h4>🌤️ 詳細天気予報（${daysUntil === 0 ? '今日' : daysUntil === 1 ? '明日' : `${daysUntil}日後`}）</h4>
                    <div class="weather-loading">
                        読み込み中...
                    </div>
                </div>
            `;
        }

        // 詳細天気情報を取得
        function fetchDetailedWeather(eventId, lat, lon, targetDate, daysUntil) {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,precipitation_probability,weathercode,windspeed_10m&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max&timezone=Asia/Tokyo&forecast_days=16`)
                .then(response => response.json())
                .then(data => {
                    const weatherDiv = document.getElementById('weather-' + eventId);
                    if (!weatherDiv) return;
                    
                    const dateIndex = data.daily.time.findIndex(d => d === targetDate);
                    
                    if (dateIndex === -1) {
                        weatherDiv.innerHTML = `
                            <h4>🌤️ 詳細天気予報</h4>
                            <div class="weather-error">天気予報データが取得できませんでした</div>
                        `;
                        return;
                    }
                    
                    // 日次データ
                    const weatherCode = data.daily.weathercode[dateIndex];
                    const tempMax = Math.round(data.daily.temperature_2m_max[dateIndex]);
                    const tempMin = Math.round(data.daily.temperature_2m_min[dateIndex]);
                    const precipitation = data.daily.precipitation_probability_max[dateIndex];
                    const windSpeed = Math.round(data.daily.windspeed_10m_max[dateIndex]);
                    
                    const weatherInfo = getWeatherInfo(weatherCode);
                    
                    // 時間ごとのデータ（9時、12時、15時、18時）
                    const targetHours = [9, 12, 15, 18];
                    const hourlyData = [];
                    
                    data.hourly.time.forEach((time, index) => {
                        const timeDate = new Date(time);
                        if (timeDate.toISOString().split('T')[0] === targetDate) {
                            const hour = timeDate.getHours();
                            if (targetHours.includes(hour)) {
                                hourlyData.push({
                                    hour: hour,
                                    temp: Math.round(data.hourly.temperature_2m[index]),
                                    precipitation: data.hourly.precipitation_probability[index],
                                    weatherCode: data.hourly.weathercode[index],
                                    windSpeed: Math.round(data.hourly.windspeed_10m[index])
                                });
                            }
                        }
                    });
                    
                    // 服装アドバイス
                    const clothingAdvice = getClothingAdvice(tempMax, tempMin, precipitation, windSpeed);
                    
                    // 体感温度の計算（簡易版）
                    const feelsLike = Math.round(tempMax - (windSpeed * 0.5));
                    
                    weatherDiv.innerHTML = `
                        <h4>🌤️ 詳細天気予報（${daysUntil === 0 ? '今日' : daysUntil === 1 ? '明日' : `${daysUntil}日後`}）</h4>
                        
                        <div class="weather-current">
                            <div class="weather-icon-large">${weatherInfo.icon}</div>
                            <div class="weather-main-info">
                                <div class="weather-temp-large">${tempMax}°</div>
                                <div class="weather-description-large">${weatherInfo.description}</div>
                                <div class="weather-feels-like">体感温度 ${feelsLike}°</div>
                            </div>
                        </div>
                        
                        <h5 style="color: white; margin-bottom: 10px; font-size: 1em;">⏰ 時間ごとの予報</h5>
                        <div class="hourly-weather">
                            ${hourlyData.map(h => {
                                const hWeather = getWeatherInfo(h.weatherCode);
                                return `
                                    <div class="hour-item">
                                        <div class="time">${h.hour}:00</div>
                                        <div class="icon">${hWeather.icon}</div>
                                        <div class="temp">${h.temp}°</div>
                                        <div class="rain">💧${h.precipitation}%</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="weather-details-grid">
                            <div class="weather-detail-item">
                                <div class="label">最高 / 最低</div>
                                <div class="value">${tempMax}° / ${tempMin}°</div>
                            </div>
                            <div class="weather-detail-item">
                                <div class="label">降水確率</div>
                                <div class="value">${precipitation}%</div>
                            </div>
                            <div class="weather-detail-item">
                                <div class="label">風速</div>
                                <div class="value">${windSpeed}km/h</div>
                            </div>
                        </div>
                        
                        <div class="clothing-advice">
                            <h5>👔 服装アドバイス</h5>
                            <div class="clothing-items">
                                ${clothingAdvice.map(item => `<span class="clothing-item">${item}</span>`).join('')}
                            </div>
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('天気予報の取得に失敗:', error);
                    const weatherDiv = document.getElementById('weather-' + eventId);
                    if (weatherDiv) {
                        weatherDiv.innerHTML = `
                            <h4>🌤️ 詳細天気予報</h4>
                            <div class="weather-error">天気予報の取得に失敗しました</div>
                        `;
                    }
                });
        }

        // 服装アドバイスを取得
        function getClothingAdvice(tempMax, tempMin, precipitation, windSpeed) {
            const advice = [];
            
            // 気温による服装
            if (tempMax > 30) {
                advice.push('🥵 薄着・通気性の良い服');
                advice.push('🧢 帽子');
                advice.push('😎 サングラス');
            } else if (tempMax > 25) {
                advice.push('👕 半袖でOK');
                advice.push('🧢 帽子があると快適');
            } else if (tempMax > 20) {
                advice.push('👔 長袖シャツ');
                advice.push('🧥 薄手の上着');
            } else if (tempMax > 15) {
                advice.push('🧥 ジャケット');
                advice.push('👖 長ズボン');
            } else if (tempMax > 10) {
                advice.push('🧥 コート');
                advice.push('🧣 マフラー');
            } else {
                advice.push('🧥 厚手のコート');
                advice.push('🧣 マフラー');
                advice.push('🧤 手袋');
            }
            
            // 降水確率による装備
            if (precipitation > 70) {
                advice.push('☔ 傘必須');
                advice.push('🥾 防水の靴');
            } else if (precipitation > 40) {
                advice.push('🌂 折りたたみ傘');
            }
            
            // 風速による注意
            if (windSpeed > 40) {
                advice.push('💨 風対策（帽子注意）');
            }
            
            // 共通アイテム
            advice.push('👟 歩きやすい靴');
            advice.push('💧 水分補給用の飲み物');
            
            return advice;
        }
        
        // 天気情報を取得
        function fetchWeather(eventId, lat, lon, targetDate, daysUntil) {
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max&timezone=Asia/Tokyo&forecast_days=16`)
                .then(response => response.json())
                .then(data => {
                    const weatherDiv = document.getElementById('weather-' + eventId);
                    if (!weatherDiv) return;
                    
                    const dateIndex = data.daily.time.findIndex(d => d === targetDate);
                    
                    if (dateIndex === -1) {
                        weatherDiv.innerHTML = `
                            <h4>☁️ 天気予報</h4>
                            <div class="weather-error">天気予報データが取得できませんでした</div>
                        `;
                        return;
                    }
                    
                    const weatherCode = data.daily.weathercode[dateIndex];
                    const tempMax = Math.round(data.daily.temperature_2m_max[dateIndex]);
                    const tempMin = Math.round(data.daily.temperature_2m_min[dateIndex]);
                    const precipitation = data.daily.precipitation_probability_max[dateIndex];
                    const windSpeed = Math.round(data.daily.windspeed_10m_max[dateIndex]);
                    
                    const weatherInfo = getWeatherInfo(weatherCode);
                    
                    let advice = '';
                    if (precipitation > 70) {
                        advice = '☔ 雨の可能性が高いです。傘を忘れずに！';
                    } else if (precipitation > 40) {
                        advice = '🌂 雨が降るかもしれません。折りたたみ傘があると安心です。';
                    } else if (tempMax > 30) {
                        advice = '🥵 暑くなりそうです。水分補給を忘れずに！';
                    } else if (tempMax < 10) {
                        advice = '🧥 寒くなりそうです。暖かい服装で！';
                    } else if (windSpeed > 40) {
                        advice = '💨 風が強くなりそうです。帽子など飛ばされないように注意！';
                    } else {
                        advice = '😊 良い天気になりそうです！楽しんできてください！';
                    }
                    
                    weatherDiv.innerHTML = `
                        <h4>☁️ 天気予報（${daysUntil === 0 ? '今日' : daysUntil === 1 ? '明日' : `${daysUntil}日後`}）</h4>
                        <div class="weather-info">
                            <div class="weather-icon">${weatherInfo.icon}</div>
                            <div class="weather-details">
                                <div class="weather-temp">${tempMax}° / ${tempMin}°</div>
                                <div class="weather-description">${weatherInfo.description}</div>
                            </div>
                        </div>
                        <div class="weather-extra">
                            <div class="weather-extra-item">
                                <span class="label">降水確率</span>
                                <span class="value">${precipitation}%</span>
                            </div>
                            <div class="weather-extra-item">
                                <span class="label">風速</span>
                                <span class="value">${windSpeed}km/h</span>
                            </div>
                        </div>
                        <div class="weather-advice">
                            💡 ${advice}
                        </div>
                    `;
                })
                .catch(error => {
                    console.error('天気予報の取得に失敗:', error);
                    const weatherDiv = document.getElementById('weather-' + eventId);
                    if (weatherDiv) {
                        weatherDiv.innerHTML = `
                            <h4>☁️ 天気予報</h4>
                            <div class="weather-error">天気予報の取得に失敗しました</div>
                        `;
                    }
                });
        }
        
        // 天気コードを絵文字と説明に変換
        function getWeatherInfo(code) {
            const weatherMap = {
                0: { icon: '☀️', description: '快晴' },
                1: { icon: '🌤️', description: '晴れ' },
                2: { icon: '⛅', description: '曇り時々晴れ' },
                3: { icon: '☁️', description: '曇り' },
                45: { icon: '🌫️', description: '霧' },
                48: { icon: '🌫️', description: '霧氷' },
                51: { icon: '🌧️', description: '小雨' },
                53: { icon: '🌧️', description: '雨' },
                55: { icon: '🌧️', description: '大雨' },
                61: { icon: '🌧️', description: '小雨' },
                63: { icon: '🌧️', description: '雨' },
                65: { icon: '🌧️', description: '大雨' },
                71: { icon: '🌨️', description: '小雪' },
                73: { icon: '🌨️', description: '雪' },
                75: { icon: '🌨️', description: '大雪' },
                77: { icon: '🌨️', description: 'みぞれ' },
                80: { icon: '🌦️', description: 'にわか雨' },
                81: { icon: '🌦️', description: '強いにわか雨' },
                82: { icon: '🌦️', description: '激しいにわか雨' },
                85: { icon: '🌨️', description: '小雪' },
                86: { icon: '🌨️', description: '大雪' },
                95: { icon: '⛈️', description: '雷雨' },
                96: { icon: '⛈️', description: '雷雨と雹' },
                99: { icon: '⛈️', description: '激しい雷雨' }
            };
            
            return weatherMap[code] || { icon: '🌤️', description: '天気不明' };
        }
        
        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }
        
        // 予定追加モーダル
        function openAddEventModal() {
            document.getElementById('addEventModalTitle').textContent = '予定を追加';
            document.getElementById('addEventForm').reset();
            document.getElementById('editEventId').value = '';
            document.getElementById('saveEventBtn').textContent = '保存';
            document.getElementById('addEventModal').style.display = 'block';
        }
        
        function closeAddEventModal() {
            document.getElementById('addEventModal').style.display = 'none';
        }
        
        // カスタム予定を保存
        function saveCustomEvent(e) {
            e.preventDefault();
            
            const id = document.getElementById('editEventId').value || 'custom_' + Date.now();
            const name = document.getElementById('eventName').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value || '-';
            const venue = document.getElementById('eventVenue').value || '-';
            const price = parseInt(document.getElementById('eventPrice').value) || 0;
            const description = document.getElementById('eventDescription').value || '';
            
            const newEvent = {
                id: id,
                name: name,
                date: date,
                time: time,
                venue: venue,
                price: price,
                description: description,
                status: 'マイ予定',
                isCustom: true
            };
            
            // 編集 or 新規
            const existingIndex = customEvents.findIndex(e => e.id === id);
            if (existingIndex >= 0) {
                customEvents[existingIndex] = newEvent;
            } else {
                customEvents.push(newEvent);
            }
            
            saveCustomEventsToStorage();
            closeAddEventModal();
            renderNextEventCountdown();
            renderSummary();
            renderView();
            
            alert('予定を保存しました！');
        }
        
        // カスタム予定を編集
        function editCustomEvent(id) {
            const event = customEvents.find(e => e.id === id);
            if (!event) return;
            
            document.getElementById('addEventModalTitle').textContent = '予定を編集';
            document.getElementById('eventName').value = event.name;
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTime').value = event.time === '-' ? '' : event.time;
            document.getElementById('eventVenue').value = event.venue === '-' ? '' : event.venue;
            document.getElementById('eventPrice').value = event.price;
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('editEventId').value = id;
            document.getElementById('saveEventBtn').textContent = '更新';
            
            document.getElementById('addEventModal').style.display = 'block';
        }
        
        // カスタム予定を削除
        function deleteCustomEvent(id) {
            if (!confirm('この予定を削除しますか？')) return;
            
            customEvents = customEvents.filter(e => e.id !== id);
            saveCustomEventsToStorage();
            renderNextEventCountdown();
            renderSummary();
            renderView();
            
            alert('予定を削除しました');
        }
        
        window.onclick = function(event) {
            const eventModal = document.getElementById('eventModal');
            const addEventModal = document.getElementById('addEventModal');
            const themeModal = document.getElementById('themeModal');  // ← 追加
            const notificationModal = document.getElementById('notificationModal');  // ← 追加
            const routeModal = document.getElementById('routeModal');  // ← 追加
            if (event.target == eventModal) {
                closeModal();
            }
            if (event.target == addEventModal) {
                closeAddEventModal();
            }
            if (event.target == themeModal) {  // ← 追加
                closeThemeModal();
            }
            if (event.target == notificationModal) {  // ← 追加
                closeNotificationModal();
            }
            if (event.target == routeModal) {  // ← 追加
                closeRouteModal();
            }
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            return `${date.getFullYear()}年${date.getMonth()+1}月${date.getDate()}日 (${days[date.getDay()]})`;
        }
        
        function switchView(view) {
            currentView = view;
            
            // ボタンのアクティブ状態を更新
            document.querySelectorAll('.view-toggle button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // クリックされたボタンをアクティブに
            const buttons = document.querySelectorAll('.view-toggle button');
            if (view === 'calendar') {
                buttons[0].classList.add('active');
            } else {
                buttons[1].classList.add('active');
            }
            
            // ビューの切り替え
            const calendarView = document.getElementById('calendarView');
            const listView = document.getElementById('listView');
            
            if (view === 'calendar') {
                calendarView.style.display = 'grid';
                listView.style.display = 'none';
                renderCalendarView();
                console.log('カレンダービュー表示');
            } else {
                calendarView.style.display = 'none';
                listView.style.display = 'block';
                renderListView();
                console.log('リストビュー表示');
            }
        }
        
        document.getElementById('searchInput').addEventListener('input', renderView);
        document.getElementById('dateFilter').addEventListener('change', renderView);
        
        // Service Worker登録（PWA対応）
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker登録成功'))
                    .catch(err => console.log('Service Worker登録失敗:', err));
            });
        }
        
        // PWAインストールプロンプト
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });
        
        function showInstallButton() {
            const installBtn = document.createElement('button');
            installBtn.className = 'add-event-btn';
            installBtn.innerHTML = '📲 ホーム画面に追加';
            installBtn.style.marginLeft = '10px';
            installBtn.onclick = async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('インストール:', outcome);
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                }
            };
            document.querySelector('.view-toggle').appendChild(installBtn);
        }
        // テーマモーダル関連
        function openThemeModal() {
            renderThemeGrid();
            document.getElementById('themeModal').style.display = 'block';
        }

        function closeThemeModal() {
            document.getElementById('themeModal').style.display = 'none';
        }

        function renderThemeGrid() {
            const grid = document.getElementById('themeGrid');
            let html = '';
            
            themes.forEach((theme, index) => {
                // 現在のテーマと完全一致しているかチェック
                const isActive = currentTheme && 
                            currentTheme.color1 === theme.color1 && 
                            currentTheme.color2 === theme.color2;
                
                html += `
                    <div class="theme-card ${isActive ? 'active' : ''}" 
                        style="background: linear-gradient(135deg, ${theme.color1} 0%, ${theme.color2} 100%)"
                        onclick="selectTheme(${index})">
                        <div style="font-size: 2em; margin-bottom: 8px;">${theme.emoji}</div>
                        <div>${theme.name}</div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
            
            // カスタムカラーの入力欄を現在のテーマで更新
            if (currentTheme) {
                document.getElementById('customColor1').value = currentTheme.color1;
                document.getElementById('customColor2').value = currentTheme.color2;
            }
        }

        function selectTheme(index) {
            const theme = themes[index];
            applyTheme(theme.color1, theme.color2);
            saveTheme(theme.color1, theme.color2);
            renderThemeGrid();
            // モーダルを自動で閉じる（お好みで）
            // closeThemeModal();
        }

        function applyCustomTheme() {
            const color1 = document.getElementById('customColor1').value;
            const color2 = document.getElementById('customColor2').value;
            applyTheme(color1, color2);
            saveTheme(color1, color2);
            renderThemeGrid();
            alert('✨ カスタムテーマを適用しました！');
        }

        // 通知設定モーダル関連
function openNotificationModal() {
    renderNotificationSettings();
    document.getElementById('notificationModal').style.display = 'block';
}

function closeNotificationModal() {
    document.getElementById('notificationModal').style.display = 'none';
}

function renderNotificationSettings() {
    const allEvents = getAllEvents();
    let html = '';
    
    // 通知権限の状態を表示
    const permissionStatus = Notification.permission;
    
    if (permissionStatus === 'granted') {
        html += `
            <div style="background: #d4edda; color: #155724; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong>✅ 通知が有効です</strong><br>
                        <small>イベント前にブラウザ通知でお知らせします</small>
                    </div>
                    <button onclick="sendTestNotification()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        🔔 テスト通知
                    </button>
                </div>
            </div>
        `;
    } else if (permissionStatus === 'denied') {
        html += `
            <div style="background: #f8d7da; color: #721c24; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                <strong>❌ 通知が拒否されています</strong><br>
                <small>ブラウザの設定から通知を許可してください</small>
            </div>
        `;
    } else {
        html += `
            <div style="background: #fff3cd; color: #856404; padding: 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                    <div>
                        <strong>⚠️ 通知が未設定です</strong><br>
                        <small>通知を受け取るには許可が必要です</small>
                    </div>
                    <button onclick="requestNotificationPermission()" style="padding: 10px 20px; background: #ffc107; color: #000; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        🔔 通知を許可
                    </button>
                </div>
            </div>
        `;
    }
    
    allEvents.forEach(event => {
        const eventId = event.id || event.name;
        const setting = getNotificationSetting(eventId);
        
        html += `
            <div class="notification-item">
                <div class="notification-header">
                    <h4>${event.name}</h4>
                    <label class="toggle-switch">
                        <input type="checkbox" 
                               ${setting.enabled ? 'checked' : ''} 
                               onchange="toggleNotification('${eventId}')">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="notification-desc">
                    📅 ${formatDate(event.date)} ${event.time || ''}
                </div>
                <div class="notification-options" id="notif-options-${eventId}" 
                     style="display: ${setting.enabled ? 'flex' : 'none'}">
                    <label>
                        <input type="checkbox" 
                               ${setting.threeDaysBefore ? 'checked' : ''} 
                               onchange="updateNotificationOption('${eventId}', 'threeDaysBefore')">
                        📅 3日前（朝9時）
                    </label>
                    <label>
                        <input type="checkbox" 
                               ${setting.oneDayBefore ? 'checked' : ''} 
                               onchange="updateNotificationOption('${eventId}', 'oneDayBefore')">
                        📅 1日前（夜8時）
                    </label>
                    <label>
                        <input type="checkbox" 
                               ${setting.morning ? 'checked' : ''} 
                               onchange="updateNotificationOption('${eventId}', 'morning')">
                        🌅 当日朝（朝7時）
                    </label>
                </div>
            </div>
        `;
    });
    
    document.getElementById('notificationSettings').innerHTML = html;
}

function toggleNotification(eventId) {
    const setting = getNotificationSetting(eventId);
    setting.enabled = !setting.enabled;
    
    const options = document.getElementById(`notif-options-${eventId}`);
    if (options) {
        options.style.display = setting.enabled ? 'flex' : 'none';
    }
    
    saveNotificationSettings();
    renderSummary();
    renderView();
}

    function updateNotificationOption(eventId, option) {
        const setting = getNotificationSetting(eventId);
        setting[option] = !setting[option];
        saveNotificationSettings();
    }

    // ルート最適化モーダル関連
    function openRouteModal() {
        renderRouteOptimization();
        document.getElementById('routeModal').style.display = 'block';
    }

    function closeRouteModal() {
        document.getElementById('routeModal').style.display = 'none';
    }

    // 最適化対象のイベントをフィルタリング
    function filterOptimizableEvents(events) {
        if (events.length === 0) return [];
        
        // 今日以降のイベントのみ（過去は除外）
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const futureEvents = events.filter(e => {
            const eventDate = new Date(e.date);
            eventDate.setHours(0, 0, 0, 0);
            return eventDate >= today; // 今日以降のみ
        });
        
        if (futureEvents.length === 0) return [];
        
        // 条件：同じ日に2つ以上のイベント
        const sameDayEvents = [];
        const dateGroups = {};
        
        futureEvents.forEach(event => {
            if (!dateGroups[event.date]) {
                dateGroups[event.date] = [];
            }
            dateGroups[event.date].push(event);
        });
        
        // 同日に2つ以上のイベントがある日付を抽出
        Object.values(dateGroups).forEach(group => {
            if (group.length >= 2) {
                sameDayEvents.push(...group);
            }
        });
        
        // 重複を除いてユニーク化
        const uniqueEvents = Array.from(new Map(sameDayEvents.map(e => [(e.id || e.name), e])).values());
        
        // 日時順にソート（時系列順）
        return uniqueEvents.sort((a, b) => {
            const dateA = new Date(a.date + ' ' + (a.time?.split('~')[0].replace(/[^0-9:]/g, '') || '00:00'));
            const dateB = new Date(b.date + ' ' + (b.time?.split('~')[0].replace(/[^0-9:]/g, '') || '00:00'));
            return dateA - dateB;
        });
    }

        function renderRouteOptimization() {
        const allEvents = getAllEvents();
        
        // イベントのみをフィルター（交通費・グッズを除外）
        const events = allEvents.filter(e => 
            e.date && 
            !e.name.includes('交通費') && 
            !e.name.includes('グッズ')
        );
        
        // 時系列順にソート（マイ予定も含めて）
        const sortedEvents = events.sort((a, b) => {
            // 日付と時刻を組み合わせてソート
            const getDateTime = (event) => {
            if (!event.time) {
                return new Date(event.date + ' 00:00:00');
            }
            
            // 時刻を抽出（"9時~18時" → "09:00", "17:00(場)18:30(演)" → "17:00"）
            let timeStr = event.time;
            
            // パターン1: "9時~18時" のような形式
            const hourMatch = timeStr.match(/(\d+)時/);
            if (hourMatch) {
                const hour = hourMatch[1].padStart(2, '0');
                timeStr = `${hour}:00`;
            } else {
                // パターン2: "17:00(場)18:30(演)" のような形式
                const timeMatch = timeStr.match(/(\d+):(\d+)/);
                if (timeMatch) {
                    timeStr = `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`;
                } else {
                    timeStr = '00:00';
                }
            }
            
            return new Date(event.date + ' ' + timeStr + ':00');
        };
            
            return getDateTime(a) - getDateTime(b);
        });

        
        
        // 連続イベントまたは同日複数イベントのみを抽出
        const optimizableEvents = filterOptimizableEvents(sortedEvents);
        console.log('最適化対象イベント数:', optimizableEvents.length);

        // 最適化対象イベントを再度時系列順にソート（マイ予定含む）
        optimizableEvents.sort((a, b) => {
            const getDateTime = (event) => {
            if (!event.time) {
                return new Date(event.date + ' 00:00:00');
            }
            
            // 時刻を抽出（"9時~18時" → "09:00", "17:00(場)18:30(演)" → "17:00"）
            let timeStr = event.time;
            
            // パターン1: "9時~18時" のような形式
            const hourMatch = timeStr.match(/(\d+)時/);
            if (hourMatch) {
                const hour = hourMatch[1].padStart(2, '0');
                timeStr = `${hour}:00`;
            } else {
                // パターン2: "17:00(場)18:30(演)" のような形式
                const timeMatch = timeStr.match(/(\d+):(\d+)/);
                if (timeMatch) {
                    timeStr = `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`;
                } else {
                    timeStr = '00:00';
                }
            }
            
            return new Date(event.date + ' ' + timeStr + ':00');
        };
            
            return getDateTime(a) - getDateTime(b);
        });
        
        let html = '<div class="route-optimization">';
        
        // 最適化対象がない場合
        if (optimizableEvents.length === 0) {
            html += `
                <div style="text-align: center; padding: 50px 20px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">📅</div>
                    <h3 style="color: #667eea; margin-bottom: 15px;">ルート最適化の対象がありません</h3>
                    <p style="color: #666; line-height: 1.8;">
                        ルート最適化は以下の条件で表示されます：<br>
                        • 同じ日に2つ以上のイベント<br>
                        • 2日以上連続するイベント
                    </p>
                    <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; display: inline-block;">
                        <p style="color: #666; margin: 0;">
                            💡 予定を追加すると、効率的な移動ルートを提案します
                        </p>
                    </div>
                </div>
            `;
            html += '</div>';
            document.getElementById('routeOptimizationContent').innerHTML = html;
            return;
        }
        
        html += '<h4>📍 最適ルート（時系列順）</h4>';
        html += '<p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">効率的な移動順序と必要な情報を表示しています</p>';

        
        
        // 統計情報の初期化
        let previousVenue = null;
        let sameVenueCount = 0;
        let totalWalkTime = 0;
        let totalDistance = 0;
        let totalTransitCost = 0;

        // 最終的な時系列順ソート（この直後にループ開始）
        optimizableEvents.sort((a, b) => {
            const getDateTime = (event) => {
            if (!event.time) {
                return new Date(event.date + ' 00:00:00');
            }
            
            // 時刻を抽出（"9時~18時" → "09:00", "17:00(場)18:30(演)" → "17:00"）
            let timeStr = event.time;
            
            // パターン1: "9時~18時" のような形式
            const hourMatch = timeStr.match(/(\d+)時/);
            if (hourMatch) {
                const hour = hourMatch[1].padStart(2, '0');
                timeStr = `${hour}:00`;
            } else {
                // パターン2: "17:00(場)18:30(演)" のような形式
                const timeMatch = timeStr.match(/(\d+):(\d+)/);
                if (timeMatch) {
                    timeStr = `${timeMatch[1].padStart(2, '0')}:${timeMatch[2]}`;
                } else {
                    timeStr = '00:00';
                }
            }
            
            return new Date(event.date + ' ' + timeStr + ':00');
        };
        
    
    return getDateTime(a) - getDateTime(b);
});

console.log('=== 最終ソート後 ===');
optimizableEvents.forEach(e => console.log(`${e.date} ${e.time || '時刻なし'} - ${e.name}`));


// 日付ごとにグループ化
let currentDate = null;
let eventCounter = 0;


        optimizableEvents.forEach((event, index) => {

            eventCounter++;
    
        // 日付が変わったら日付ヘッダーを表示
        if (currentDate !== event.date) {
            currentDate = event.date;
            const eventDate = new Date(event.date);
            const days = ['日', '月', '火', '水', '木', '金', '土'];
            const dayOfWeek = days[eventDate.getDay()];
            
            html += `
                <div style="margin: 40px 0 20px 0; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <h3 style="color: white; margin: 0; font-size: 1.5em; display: flex; align-items: center; gap: 10px;">
                        📅 ${eventDate.getFullYear()}年${eventDate.getMonth() + 1}月${eventDate.getDate()}日（${dayOfWeek}）
                    </h3>
                </div>
            `;
        }
    
        
        
            const nextEvent = optimizableEvents[index + 1];
            
            // 会場間の移動情報を計算
            let moveInfo = '';
            let waitTime = '';
            
            // 前のイベントと日付が異なる場合は移動情報を表示しない
            const prevEvent = index > 0 ? optimizableEvents[index - 1] : null;
            const isSameDay = prevEvent && prevEvent.date === event.date;

            if (previousVenue && event.venue && isSameDay) {
                const prevVenueNormalized = normalizeVenueName(previousVenue);
                const currentVenueNormalized = normalizeVenueName(event.venue);
                            
                if (prevVenueNormalized === currentVenueNormalized) {
                    moveInfo = `
                        <div style="text-align: center; padding: 12px; background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%); border-radius: 8px; margin: 10px 0;">
                            <div style="color: #155724; font-weight: bold;">📍 同じ会場内</div>
                            <div style="color: #155724; font-size: 0.85em; margin-top: 4px;">移動なし・そのまま滞在</div>
                        </div>
                    `;
                    sameVenueCount++;
                } else {
                    // 会場が違う場合の移動情報
                    const moveData = calculateMovement(prevVenueNormalized, currentVenueNormalized);
                    totalWalkTime += moveData.time;
                    totalDistance += moveData.distance;
                    totalTransitCost += moveData.cost || 0;
                    
                    moveInfo = `
                        <div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #cfe2ff 0%, #b6d4fe 100%); border-radius: 8px; margin: 10px 0; border-left: 4px solid #0d6efd;">
                            <div style="color: #084298; font-size: 0.85em; margin-bottom: 5px;">移動</div>
                            <div style="font-weight: bold; color: #084298; font-size: 1.1em;">
                                ${moveData.method}
                            </div>
                            <div style="color: #084298; font-size: 0.9em; margin-top: 8px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                                <span>⏱️ ${moveData.time}分</span>
                                <span>📏 ${moveData.distance}km</span>
                                ${moveData.cost ? `<span>💰 ¥${moveData.cost}</span>` : ''}
                            </div>
                            ${moveData.route ? `<div style="color: #666; font-size: 0.85em; margin-top: 8px;">${moveData.route}</div>` : ''}
                        </div>
                    `;
                }
            }
            
            
            // 待ち時間を計算
            if (index > 0) {
                const prevEvent = optimizableEvents[index - 1];
                const prevEndTime = getEventEndTime(prevEvent);
                const currentStartTime = getEventStartTime(event);
                
                if (prevEndTime && currentStartTime) {
                    let waitMinutes = Math.floor((currentStartTime - prevEndTime) / (1000 * 60));
                    
                    // 移動時間を引く（同日で会場が違う場合のみ）
                    let travelTimeMinutes = 0;
                    if (isSameDay && previousVenue && event.venue) {
                        const prevVenueNormalized = normalizeVenueName(previousVenue);
                        const currentVenueNormalized = normalizeVenueName(event.venue);
                        
                        if (prevVenueNormalized !== currentVenueNormalized) {
                            const moveData = calculateMovement(prevVenueNormalized, currentVenueNormalized);
                            travelTimeMinutes = moveData.time;
                            waitMinutes = waitMinutes - travelTimeMinutes; // 移動時間を引く
                        }
                    }
                    if (waitMinutes > 0) {
                        const hours = Math.floor(waitMinutes / 60);
                        const mins = waitMinutes % 60;
                        
                        let waitColor = waitMinutes > 180 ? '#ffc107' : waitMinutes > 60 ? '#17a2b8' : '#6c757d';
                        let waitBg = waitMinutes > 180 ? '#fff3cd' : waitMinutes > 60 ? '#d1ecf1' : '#e2e3e5';
                        
                        waitTime = `
                        <div style="margin-top: 10px; padding: 12px; background: ${waitBg}; border-radius: 6px; border-left: 3px solid ${waitColor};">
                            <div style="color: ${waitColor}; font-weight: bold; margin-bottom: 5px;">
                                ⏰ 自由時間: ${hours > 0 ? `${hours}時間` : ''}${mins > 0 ? `${mins}分` : ''}
                                ${travelTimeMinutes > 0 ? `<span style="font-size: 0.85em; opacity: 0.8;"> (移動${travelTimeMinutes}分を除く)</span>` : ''}
                            </div>
                                ${waitMinutes > 180 ? `
                                    <div style="color: #856404; font-size: 0.85em; margin-top: 5px;">
                                        💡 長時間の待機 - 近くで食事や休憩をおすすめ
                                    </div>
                                ` : waitMinutes > 60 ? `
                                    <div style="color: #0c5460; font-size: 0.85em; margin-top: 5px;">
                                        ☕ カフェや観光の時間があります
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                }
            }
            
            // 会場の詳細情報を取得
            const venueInfo = getVenueInfo(event.venue);
            
            html += `
                ${index > 0 ? moveInfo : ''}
                
                <div class="route-step" style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div class="route-number">${eventCounter}</div>
                    <div class="route-info" style="flex: 1;">
                        <h5 style="font-size: 1.2em; margin-bottom: 10px; color: #2c3e50;">${event.name}</h5>
                        <div style="display: grid; gap: 8px; font-size: 0.95em;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #667eea;">📅</span>
                                <span style="color: #555;">${formatDate(event.date)} ${event.time || ''}</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #667eea;">📍</span>
                                <span style="color: #555;">${venueInfo.displayName || event.venue || '会場未定'}</span>
                            </div>
                            ${venueInfo.station ? `
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="color: #667eea;">🚃</span>
                                    <span style="color: #555; font-size: 0.9em;">${venueInfo.station}</span>
                                </div>
                            ` : ''}
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="color: #e74c3c;">💰</span>
                                <span style="color: #e74c3c; font-weight: bold; font-size: 1.1em;">¥${event.price.toLocaleString()}</span>
                            </div>
                        </div>
                        ${waitTime}
                    </div>
                </div>
            `;
            
            previousVenue = event.venue;
        });
        
        // サマリー計算
        const totalPrice = optimizableEvents.reduce((sum, e) => sum + (e.price || 0), 0);
        const dateRange = getDateRange(optimizableEvents);
        const needsAccommodation = checkNeedsAccommodation(optimizableEvents);
        const moveCount = optimizableEvents.length - sameVenueCount - 1;
        
        html += `
            <div class="route-summary">
                <h4 style="margin-bottom: 20px;">📊 ルートサマリー</h4>
                <div class="route-detail">
                    <div class="route-detail-item">
                        <div class="label">📅 開催期間</div>
                        <div class="value" style="font-size: 0.9em;">${dateRange}</div>
                    </div>
                    <div class="route-detail-item">
                        <div class="label">🎫 総イベント数</div>
                        <div class="value">${optimizableEvents.length}件</div>
                    </div>
                    <div class="route-detail-item">
                        <div class="label">🏢 訪問会場数</div>
                        <div class="value">${[...new Set(optimizableEvents.map(e => normalizeVenueName(e.venue)))].length}箇所</div>
                    </div>
                    <div class="route-detail-item">
                        <div class="label">🚶 会場間移動</div>
                        <div class="value">${moveCount}回</div>
                    </div>
                    <div class="route-detail-item">
                        <div class="label">⏱️ 総移動時間</div>
                        <div class="value">${totalWalkTime}分</div>
                    </div>
                    <div class="route-detail-item">
                        <div class="label">📏 総移動距離</div>
                        <div class="value">${totalDistance.toFixed(1)}km</div>
                    </div>
                    <div class="route-detail-item">
                        <div class="label">🚃 交通費</div>
                        <div class="value">¥${totalTransitCost.toLocaleString()}</div>
                    </div>
                    <div class="route-detail-item">
                        <div class="label">💰 イベント代</div>
                        <div class="value">¥${totalPrice.toLocaleString()}</div>
                    </div>
                    <div class="route-detail-item" style="grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 8px;">
                        <div class="label" style="color: white;">💵 総費用（交通費込）</div>
                        <div class="value" style="font-size: 1.8em;">¥${(totalPrice + totalTransitCost).toLocaleString()}</div>
                    </div>
                </div>
                
                ${needsAccommodation ? `
                    <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); border-radius: 8px; border-left: 4px solid #ffc107;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <span style="font-size: 1.5em;">🏨</span>
                            <strong style="color: #856404;">宿泊推奨</strong>
                        </div>
                        <div style="color: #856404; font-size: 0.9em; line-height: 1.6;">
                            連日のイベントです。会場近くのホテル予約をおすすめします。<br>
                            早めの予約でお得なプランを見つけましょう！
                        </div>
                    </div>
                ` : ''}
            </div>
            
            <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #e8f4f8 0%, #d4e9f2 100%); border-radius: 10px; border-left: 4px solid #17a2b8;">
                <h4 style="color: #0c5460; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                    <span>💡</span> おすすめポイント
                </h4>
                <ul style="color: #0c5460; font-size: 0.95em; line-height: 2; padding-left: 20px; margin: 0;">
                    ${generateRecommendations(optimizableEvents, sameVenueCount, totalWalkTime)}
                </ul>
            </div>
        `;
        
        html += '</div>';
        document.getElementById('routeOptimizationContent').innerHTML = html;
    }

    // 会場名を正規化（マッチングしやすくする）
    function normalizeVenueName(venue) {
        if (!venue) return '';
        
        const normalized = venue.toLowerCase()
            .replace(/[&＆]/g, '')
            .replace(/\s+/g, '')
            .replace(/ホール/g, '')
            .replace(/駅/g, '');
        
        // エリアごとにグループ化（詳細→エリアへの自動マッピング）
        
        // 幕張エリア
        if (normalized.includes('国際展示場') || normalized.includes('幕張メッセ') || normalized.includes('幕張')) {
            return '幕張メッセ';
        }
        
        // 有明エリア（ビッグサイト、アリーナ、ガーデンシアターを統合）
        if (normalized.includes('ビッグサイト') || normalized.includes('東京国際展示場')) {
            return '有明エリア';
        }
        if (normalized.includes('有明アリーナ')) {
            return '有明エリア';
        }
        if (normalized.includes('ガーデンシアター')) {
            return '有明エリア';
        }
        if (normalized.includes('有明')) {
            return '有明エリア';
        }
        
        // 横浜エリア（みなとみらいに統合）
        if (normalized.includes('パシフィコ')) {
            return 'みなとみらい';
        }
        if (normalized.includes('kアリーナ')) {
            return 'みなとみらい';
        }
        if (normalized.includes('ぴあアリーナ')) {
            return 'みなとみらい';
        }
        if (normalized.includes('みなとみらい')) {
            return 'みなとみらい';
        }
        if (normalized.includes('横浜')) {
            return '横浜';
        }
        
        // 都心エリア
        if (normalized.includes('渋谷')) return '渋谷';
        if (normalized.includes('新宿')) return '新宿';
        if (normalized.includes('池袋')) return '池袋';
        if (normalized.includes('秋葉原')) return '秋葉原';
        
        return venue;
    }

    // 会場情報を取得
    function getVenueInfo(venue) {
        const venueKey = Object.keys(venueDatabase).find(key => 
            venue && venue.includes(key.split('&')[0].trim())
        );
        
        if (venueKey && venueDatabase[venueKey]) {
            return {
                displayName: venueDatabase[venueKey].name,
                station: venueDatabase[venueKey].station,
                address: venueDatabase[venueKey].address
            };
        }
        
        return { displayName: venue, station: null, address: null };
    }

    // 会場間の移動情報を計算（全エリア対応・完全版）
    function calculateMovement(from, to) {
        // 移動データベース（実際の所要時間・距離・料金）
        const movements = {
            // ========== 幕張メッセ内 ==========
            '幕張メッセ_幕張メッセ': { 
                method: '🚶 徒歩（館内移動）', 
                time: 5, 
                distance: 0.3, 
                cost: 0,
                route: '国際展示場4-8ホール ⇔ 1-3ホール'
            },
            
            // ========== 有明エリア内 ==========
            
            
            // ========== 横浜エリア内 ==========
            '横浜_みなとみらい': { 
                method: '🚃 みなとみらい線', 
                time: 5, 
                distance: 2, 
                cost: 193,
                route: '横浜駅 → みなとみらい駅'
            },
            'みなとみらい_横浜': { 
                method: '🚃 みなとみらい線', 
                time: 5, 
                distance: 2, 
                cost: 193,
                route: 'みなとみらい駅 → 横浜駅'
            },
            
            
            
            
            
            
            
            // ========== 都心部（渋谷・新宿・池袋・秋葉原） ==========
            '渋谷_新宿': { 
                method: '🚃 JR山手線', 
                time: 7, 
                distance: 4, 
                cost: 167,
                route: '渋谷駅 → 新宿駅（山手線）'
            },
            '新宿_渋谷': { 
                method: '🚃 JR山手線', 
                time: 7, 
                distance: 4, 
                cost: 167,
                route: '新宿駅 → 渋谷駅（山手線）'
            },
            '新宿_池袋': { 
                method: '🚃 JR埼京線（JR湘南新宿ライン）', 
                time: 5, 
                distance: 5, 
                cost: 167,
                route: '新宿駅 → 池袋駅'
            },
            '池袋_新宿': { 
                method: '🚃 JR埼京線（JR湘南新宿ライン）', 
                time: 5, 
                distance: 5, 
                cost: 167,
                route: '池袋駅 → 新宿駅'
            },
            '池袋_秋葉原': { 
                method: '🚃 JR山手線', 
                time: 20, 
                distance: 8, 
                cost: 208,
                route: '池袋駅 → 秋葉原駅（山手線）'
            },
            '秋葉原_池袋': { 
                method: '🚃 JR山手線', 
                time: 20, 
                distance: 8, 
                cost: 208,
                route: '秋葉原駅 → 池袋駅（山手線）'
            },
            '渋谷_池袋': { 
                method: '🚃 JR埼京線（JR湘南新宿ライン）', 
                time: 11, 
                distance: 9, 
                cost: 178,
                route: '渋谷駅 → 池袋駅'
            },
            '池袋_渋谷': { 
                method: '🚃 JR埼京線（JR湘南新宿ライン）', 
                time: 11, 
                distance: 9, 
                cost: 178,
                route: '池袋駅 → 渋谷駅'
            },
            '渋谷_秋葉原': { 
                method: '🚃 JR山手線→JR総武線', 
                time: 25, 
                distance: 10, 
                cost: 208,
                route: '渋谷駅 → 代々木 → 秋葉原駅（総武線）'
            },
            '秋葉原_渋谷': { 
                method: '🚃 JR総武線→JR山手線', 
                time: 25, 
                distance: 10, 
                cost: 208,
                route: '秋葉原駅（総武線）→ 代々木 → 渋谷'
            },
            '新宿_秋葉原': { 
                method: '🚃 JR中央線→JR総武線', 
                time: 14, 
                distance: 10, 
                cost: 178,
                route: '新宿駅 → 御茶ノ水駅 → 秋葉原駅（総武線）'
            },
            '秋葉原_新宿': { 
                method: '🚃 JR総武線→JR中央線', 
                time: 14, 
                distance: 10, 
                cost: 178,
                route: '秋葉原駅（総武線）→ 御茶ノ水駅 → 新宿'
            },
            
            // ========== 主要エリア間の移動 ==========
            
            // 幕張 ⇔ 有明
            '幕張メッセ_有明エリア': { 
                method: '🚃 JR京葉線→りんかい線', 
                time: 35, 
                distance: 30, 
                cost: 678,
                route: '海浜幕張 → 新木場 → 国際展示場'
            },
            '有明エリア_幕張メッセ': { 
                method: '🚃 りんかい線→JR京葉線', 
                time: 35, 
                distance: 30, 
                cost: 678,
                route: '国際展示場 → 新木場 → 海浜幕張'
            },
            
            
            // 渋谷・新宿 ⇔ 有明
            '渋谷_有明エリア': { 
                method: '🚃 りんかい線', 
                time: 25, 
                distance: 12, 
                cost: 502,
                route: '渋谷 → 国際展示場'
            },
            '有明エリア_渋谷': { 
                method: '🚃 りんかい線', 
                time: 25, 
                distance: 12, 
                cost: 502,
                route: '国際展示場 → 渋谷'
            },
            '新宿_有明エリア': { 
                method: '🚃 りんかい線', 
                time: 27, 
                distance: 15, 
                cost: 513,
                route: '新宿 → 国際展示場'
            },
            '有明エリア_新宿': { 
                method: '🚃 りんかい線', 
                time: 27, 
                distance: 15, 
                cost: 513,
                route: '国際展示場 → 新宿'
            },
            
            
            // 渋谷・新宿 ⇔ 横浜
            '渋谷_横浜': { 
                method: '🚃 東急東横線', 
                time: 46, 
                distance: 25, 
                cost: 309,
                route: '渋谷 → 横浜（東急東横線）'
            },
            '横浜_渋谷': { 
                method: '🚃 東急東横線', 
                time: 46, 
                distance: 25, 
                cost: 309,
                route: '横浜 → 渋谷（東急東横線）'
            },
            '新宿_横浜': { 
                method: '🚃 JR山手線・東急東横線', 
                time: 45, 
                distance: 28, 
                cost: 476,
                route: '新宿 → 渋谷 → 横浜（東急東横線）'
            },
            '横浜_新宿': { 
                method: '🚃 東急東横線→JR山手線', 
                time: 45, 
                distance: 28, 
                cost: 476,
                route: '横浜（東急東横線）→ 渋谷 → 新宿'
            },
            '渋谷_みなとみらい': { 
                method: '🚃 東急東横線→みなとみらい線', 
                time: 35, 
                distance: 27, 
                cost: 502,
                route: '渋谷 → みなとみらい（みなとみらい線直通）'
            },
            'みなとみらい_渋谷': { 
                method: '🚃 みなとみらい線→東急東横線', 
                time: 35, 
                distance: 27, 
                cost: 502,
                route: 'みなとみらい → 渋谷（東急東横線直通）'
            },
            
            // 有明 ⇔ 横浜
            '有明エリア_横浜': { 
                method: '🚃 りんかい線→JR京浜東北線', 
                time: 43, 
                distance: 35, 
                cost: 638,
                route: '国際展示場 → 大井町 → 横浜'
            },
            '横浜_有明エリア': { 
                method: '🚃 JR京浜東北線→りんかい線', 
                time: 43, 
                distance: 35, 
                cost: 638,
                route: '横浜 → 大井町 → 国際展示場'
            },
            
            '有明エリア_みなとみらい': { 
                method: '🚃 りんかい線→JR京浜東北線→みなとみらい線', 
                time: 55, 
                distance: 37, 
                cost: 831,
                route: '国際展示場 → 大井町 → 横浜 → みなとみらい'
            },
            'みなとみらい_有明エリア': { 
                method: '🚃 みなとみらい線→JR京浜東北線→りんかい線', 
                time: 55, 
                distance: 37, 
                cost: 831,
                route: 'みなとみらい → 横浜 → 大井町 → 国際展示場'
            },
            
            // 幕張 ⇔ 横浜
            '幕張メッセ_横浜': { 
                method: '🚃 JR京葉線→JR東海道線→京急本線', 
                time: 80, 
                distance: 55, 
                cost: 972,
                route: '海浜幕張 → 東京 → 品川 → 横浜'
            },
            '横浜_幕張メッセ': { 
                method: '🚃 京急本線→JR東海道線→JR京葉線', 
                time: 80, 
                distance: 55, 
                cost: 972,
                route: '横浜 → 東京 → 海浜幕張'
            },
            '幕張メッセ_みなとみらい': { 
                method: '🚃 JR京葉線→JR東海道線（JR山手線）→京急本線→みなとみらい線', 
                time: 85, 
                distance: 57, 
                cost: 1165,
                route: '海浜幕張 → 東京 → 品川 → 横浜 → みなとみらい'
            },
            'みなとみらい_幕張メッセ': { 
                method: '🚃 みなとみらい線→京急本線→JR東海道線（JR山手線）→JR京葉線', 
                time: 85, 
                distance: 57, 
                cost: 1170,
                route: 'みなとみらい → 横浜 → 品川 → 東京 → 海浜幕張'
            },
            
            // 池袋・秋葉原 ⇔ 有明
            '池袋_有明エリア': { 
                method: '🚃 JR埼京線→りんかい線', 
                time: 33, 
                distance: 18, 
                cost: 543,
                route: '池袋 → 国際展示場'
            },
            '有明エリア_池袋': { 
                method: '🚃 りんかい線→JR埼京線', 
                time: 33, 
                distance: 18, 
                cost: 543,
                route: '国際展示場 → 池袋'
            },
            '秋葉原_有明エリア': { 
                method: '🚃 JR山手線→りんかい線', 
                time: 39, 
                distance: 12, 
                cost: 543,
                route: '秋葉原 → 大崎 → 国際展示場'
            },
            '有明エリア_秋葉原': { 
                method: '🚃 りんかい線→JR山手線', 
                time: 39, 
                distance: 12, 
                cost: 543,
                route: '国際展示場 → 大崎 → 秋葉原'
            },

            // 幕張エリア
            '幕張メッセ_新宿': { 
                method: '🚃 JR京葉線→JR中央線', 
                time: 56, 
                distance: 42, 
                cost: 659,
                route: '海浜幕張 → 東京 → 新宿'
            },
            '新宿_幕張メッセ': { 
                method: '🚃 JR中央線→JR京葉線', 
                time: 56, 
                distance: 42, 
                cost: 659,
                route: '新宿 → 東京 → 海浜幕張'
            },
            '幕張メッセ_渋谷': { 
                method: '🚃 JR京葉線→JR山手線', 
                time: 70, 
                distance: 45, 
                cost: 736,
                route: '海浜幕張 → 東京 → 渋谷'
            },
            '渋谷_幕張メッセ': { 
                method: '🚃 JR山手線→JR京葉線', 
                time: 70, 
                distance: 45, 
                cost: 736,
                route: '渋谷 → 東京 → 海浜幕張'
            },
            '幕張メッセ_池袋': { 
                method: '🚃 JR京葉線→東京メトロ有楽町線', 
                time: 70, 
                distance: 41, 
                cost: 658,
                route: '海浜幕張 → 新木場 → 池袋'
            },
            '池袋_幕張メッセ': { 
                method: '🚃 東京メトロ有楽町線→JR京葉線', 
                time: 70, 
                distance: 41, 
                cost: 658,
                route: '池袋 → 東京 → 海浜幕張'
            },
            '幕張メッセ_秋葉原': { 
                method: '🚃 JR京葉線→JR京浜東北線', 
                time: 55, 
                distance: 33, 
                cost: 571,
                route: '海浜幕張 → 東京 → 秋葉原'
            },
            '秋葉原_幕張メッセ': { 
                method: '🚃 JR京浜東北線→JR京葉線', 
                time: 55, 
                distance: 33, 
                cost: 571,
                route: '海浜幕張 → 東京 → 新宿'
            },
            // 横浜→首都圏
            '新宿_みなとみらい': { 
                method: '🚃 JR山手線（JR埼京線・JR湘南新宿ライン）→東急東横線（みなとみらい線直通）', 
                time: 55, 
                distance: 29, 
                cost: 669,
                route: '新宿 → 渋谷 → みなとみらい'
            },
            'みなとみらい_新宿': { 
                method: '🚃 みなとみらい線（東急東横線直通）→JR山手線（JR埼京線・JR湘南新宿ライン）', 
                time: 55, 
                distance: 29, 
                cost: 669,
                route: 'みなとみらい → 渋谷 → 新宿'
            },
            '秋葉原_横浜': { 
                method: '🚃 JR京浜東北線→京急本線', 
                time: 47, 
                distance: 31, 
                cost: 491,
                route: '秋葉原 → 品川 → 横浜'
            },
            '横浜_秋葉原': { 
                method: '🚃 京急本線→JR京浜東北線', 
                time: 47, 
                distance: 31, 
                cost: 491,
                route: '横浜 → 品川 → 秋葉原'
            },
            '秋葉原_みなとみらい': { 
                method: '🚃 JR山手線→京急本線→みなとみらい線', 
                time: 55, 
                distance: 32, 
                cost: 684,
                route: '秋葉原 → 品川 → 横浜 → みなとみらい'
            },
            'みなとみらい_秋葉原': { 
                method: '🚃 みなとみらい線→京急本線→JR山手線', 
                time: 55, 
                distance: 32, 
                cost: 684,
                route: 'みなとみらい → 横浜 → 品川 → 秋葉原'
            },
            '池袋_横浜': { 
                method: '🚃 東京メトロ副都心線（東急東横線直通）', 
                time: 45, 
                distance: 33, 
                cost: 518,
                route: '池袋 → 横浜'
            },
            '横浜_池袋': { 
                method: '🚃 東急東横線（東京メトロ副都心線直通）', 
                time: 45, 
                distance: 33, 
                cost: 518,
                route: '横浜 → 池袋'
            },
            '池袋_みなとみらい': { 
                method: '🚃 JR埼京線→東急東横線（みなとみらい線直通）', 
                time: 60, 
                distance: 34, 
                cost: 680,
                route: '池袋 → 渋谷 → みなとみらい'
            },
            'みなとみらい_池袋': { 
                method: '🚃 みなとみらい線（東急東横線直通）→JR埼京線', 
                time: 60, 
                distance: 34, 
                cost: 680,
                route: 'みなとみらい→ 渋谷 → 池袋'
            }
        };
        
        // 完全一致を探す
        const key = `${from}_${to}`;
        if (movements[key]) {
            return movements[key];
        }
        
        // デフォルト（データがない場合）
        console.warn(`移動データが未定義: ${from} → ${to}`);
        return { 
            method: '🚃 電車', 
            time: 30, 
            distance: 15, 
            cost: 400,
            route: '経路を確認してください'
        };
    }

    // イベントの終了時刻を取得
    function getEventEndTime(event) {
        if (!event.time || !event.date) return null;
        const endTimeMatch = event.time.match(/[~〜～](\d+):(\d+)/);
        if (!endTimeMatch) {
            // 終了時刻がない場合は開始から3時間後と仮定
            const startTime = getEventStartTime(event);
            if (startTime) {
                const endTime = new Date(startTime);
                endTime.setHours(endTime.getHours() + 3);
                return endTime;
            }
            return null;
        }
        
        const date = new Date(event.date);
        let hours = parseInt(endTimeMatch[1]);
        const minutes = parseInt(endTimeMatch[2]);
        
        // 24時を超える場合（例: 25:00 = 翌1:00）
        if (hours >= 24) {
            date.setDate(date.getDate() + 1);
            hours = hours - 24;
        }
        
        date.setHours(hours, minutes, 0, 0);
        return date;
    }

    // イベントの開始時刻を取得
    function getEventStartTime(event) {
        if (!event.time || !event.date) return null;
        
        // 「場」「演」などの表記を除去
        const timeStr = event.time.replace(/[(（]場[)）]|[(（]演[)）]/g, '');
        const startTimeMatch = timeStr.match(/(\d+):(\d+)/);
        if (!startTimeMatch) return null;
        
        const date = new Date(event.date);
        date.setHours(parseInt(startTimeMatch[1]), parseInt(startTimeMatch[2]), 0, 0);
        return date;
    }

    // 開催期間を取得
    function getDateRange(events) {
        if (events.length === 0) return '-';
        const dates = events.map(e => new Date(e.date)).sort((a, b) => a - b);
        const first = dates[0];
        const last = dates[dates.length - 1];
        
        if (first.getTime() === last.getTime()) {
            return `${first.getMonth() + 1}月${first.getDate()}日`;
        }
        
        const days = Math.ceil((last - first) / (1000 * 60 * 60 * 24)) + 1;
        return `${first.getMonth() + 1}月${first.getDate()}日～${last.getMonth() + 1}月${last.getDate()}日（${days}日間）`;
    }

    // 宿泊が必要かチェック
    function checkNeedsAccommodation(events) {
        const dates = [...new Set(events.map(e => e.date))].sort();
        if (dates.length <= 1) return false;
        
        // 連続する日付があるかチェック
        for (let i = 0; i < dates.length - 1; i++) {
            const diff = (new Date(dates[i + 1]) - new Date(dates[i])) / (1000 * 60 * 60 * 24);
            if (diff === 1) return true;
        }
        return false;
    }

    // おすすめポイントを生成
    function generateRecommendations(events, sameVenueCount, totalWalkTime) {
        const recommendations = [];
        
        // 同じ会場でのイベント
        if (sameVenueCount > 0) {
            recommendations.push(`<li>✅ ${sameVenueCount + 1}イベントが同じ会場で効率的です</li>`);
        }
        
        // 会場別の推奨
        const venues = [...new Set(events.map(e => normalizeVenueName(e.venue)))];
        if (venues.length === 1) {
            recommendations.push(`<li>✅ すべて同じエリアで完結するので移動が楽です</li>`);
        }
        
        if (venues.includes('幕張メッセ')) {
            recommendations.push(`<li>🏨 幕張エリア: 海浜幕張駅周辺のホテルが便利</li>`);
            recommendations.push(`<li>🍴 幕張エリア: イオンモール幕張新都心で食事・買い物ができます</li>`);
        }
        
        if (venues.includes('有明エリア') || venues.includes('東京ビッグサイト')) {
            recommendations.push(`<li>🏨 有明エリア: 国際展示場駅・有明駅周辺のホテルがおすすめ</li>`);
            recommendations.push(`<li>🍴 有明エリア: 有明ガーデンで食事・休憩ができます</li>`);
        }
        
        if (venues.includes('みなとみらい') || venues.includes('横浜')) {
            recommendations.push(`<li>🏨 横浜エリア: みなとみらい・桜木町周辺のホテルが便利</li>`);
            recommendations.push(`<li>🍴 横浜エリア: みなとみらいは飲食店が充実しています</li>`);
        }
        
        if (venues.includes('渋谷') || venues.includes('新宿') || venues.includes('池袋')) {
            recommendations.push(`<li>🚃 都心部は電車移動が便利 - ICカードの残高確認を</li>`);
        }
        
        // 移動時間によるアドバイス
        if (totalWalkTime > 60) {
            recommendations.push(`<li>👟 移動時間が長めです - 歩きやすい靴がおすすめ</li>`);
        }
        
        // 同日に複数イベント
        const sameDay = events.filter((e, i, arr) => 
            arr.filter(ev => ev.date === e.date).length > 1
        );
        
        if (sameDay.length > 0) {
            recommendations.push(`<li>⚠️ 同日に複数イベントあり - 体力配分と時間管理に注意</li>`);
        }
        
        // 一般的なアドバイス
        recommendations.push(`<li>💡 チェックリストで持ち物を事前確認しましょう</li>`);
        recommendations.push(`<li>🗺️ 各会場のアクセス方法を事前にチェック</li>`);
        recommendations.push(`<li>📱 スマホの充電器を忘れずに</li>`);
        
        return recommendations.join('');
    }

        init();
    </script>
</body>
</html>